{{ 'shopdev-recently-viewed-products.css' | asset_url | stylesheet_tag }}

<style>
  .shopdev-recently-viewed-products .text-heading {
    color: #0A0A0A;
  }
  
  .shopdev-recently-viewed-products .text-variant {
    color: #4A5565;
  }
  
  .shopdev-recently-viewed-products .text-price {
    color: #585858;
  }
  
  .shopdev-recently-viewed-products .text-original-price {
    color: #6A7282;
  }
  
  .shopdev-recently-viewed-products .text-additional-colors {
    color: #858585;
  }
  
  
  .shopdev-recently-viewed-products .swatch-black {
    background-color: #000000;
  }
  
  .shopdev-recently-viewed-products .swatch-silver {
    background-color: #C0C0C0;
  }
  
  .shopdev-recently-viewed-products .swatch-purple {
    background-color: #9D98FF;
  }
  
  .shopdev-recently-viewed-products .swatch-red {
    background-color: #FF0C14;
  }
  
  .shopdev-recently-viewed-products .border-swatch-active {
    border-color: #99A1AF;
  }
  
  .shopdev-recently-viewed-products .border-swatch {
    border-color: #E5E7EB;
  }
  
  .shopdev-recently-viewed-products .product-card {
    transition: transform 0.3s ease;
    box-shadow: -1px 4px 16px rgba(0, 0, 0, 0.15);
  }
  
  .shopdev-recently-viewed-products .product-card:hover {
    transform: translateY(-4px);
  }
  
  .shopdev-recently-viewed-products .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  
  .shopdev-recently-viewed-products .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  
  .shopdev-recently-viewed-products .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    word-break: break-word;
    overflow-wrap: break-word;
  }

  .shopdev-recently-viewed-products .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
    word-break: break-word;
    overflow-wrap: break-word;
  }

  .shopdev-recently-viewed-products .product-card {
    width: 192px !important;
    min-width: 192px !important;
    max-width: 192px !important;
    box-sizing: border-box;
  }

  .shopdev-recently-viewed-products .product-card * {
    max-width: 100%;
    box-sizing: border-box;
  }

  .shopdev-recently-viewed-products .product-card h3,
  .shopdev-recently-viewed-products .product-card p {
    width: 100%;
    min-width: 0;
  }

  @media (max-width: 768px) {
    .shopdev-recently-viewed-products .product-grid {
      gap: 12px;
    }

    .shopdev-recently-viewed-products .product-card {
      min-width: 180px;
    }
  }
</style>

{%- liquid
  assign brand_new_collection = section.settings.collection
  assign renewed_collection = section.settings.collection_renewed
  assign has_collections = false
  if brand_new_collection != blank or renewed_collection != blank
    assign has_collections = true
  endif
-%}

<div class="w-full px-[16px] md:px-[24px] recently-viewed-section" data-section-id="{{ section.id }}" style="padding-top: {{ section.settings.padding_top }}px; padding-bottom: {{ section.settings.padding_bottom }}px;">
  <div style="max-width: 1270px; margin: 0 auto;">
    <h2 class="text-heading font-bold text-[20px] leading-[30px] mb-[24px]">
      {{ section.settings.heading }}
    </h2>

    {% if has_collections %}
      {%- comment -%} BRAND NEW PRODUCTS - Visible by default {%- endcomment -%}
      <div data-mode-content="brand-new" class="overflow-x-auto scrollbar-hide">
        <div class="flex gap-[24px] pb-[24px]">
          {% if brand_new_collection != blank %}
            {% for product in brand_new_collection.products %}
              {%- render 'recently-viewed-card', product: product -%}
            {% endfor %}
          {% else %}
            <div class="w-full text-center py-8" style="min-width: 300px;">
              <p class="text-gray-500">Please select a Brand New collection in Theme Editor.</p>
            </div>
          {% endif %}
        </div>
      </div>

      {%- comment -%} RENEWED PRODUCTS - Hidden by default {%- endcomment -%}
      <div data-mode-content="renewed" class="overflow-x-auto scrollbar-hide" style="display: none;">
        <div class="flex gap-[24px] pb-[24px]">
          {% if renewed_collection != blank %}
            {% for product in renewed_collection.products %}
              {%- render 'recently-viewed-card', product: product -%}
            {% endfor %}
          {% else %}
            <div class="w-full text-center py-8" style="min-width: 300px;">
              <p class="text-gray-500">Please select a Renewed collection in Theme Editor.</p>
            </div>
          {% endif %}
        </div>
      </div>
    {% else %}
      {%- comment -%} Fallback to blocks if no collections selected {%- endcomment -%}
      <div class="overflow-x-auto scrollbar-hide">
        <div class="flex gap-[24px] pb-[24px]">
          {% for block in section.blocks %}
            {% assign product = block.settings.product %}
            {% if product != blank %}
              {%- render 'recently-viewed-card', product: product, block: block -%}
            {% endif %}
          {% endfor %}
          {% if section.blocks.size == 0 %}
            <div class="w-full text-center py-8" style="min-width: 300px;">
              <p class="text-gray-500">Please select collections or add product blocks in Theme Editor.</p>
            </div>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>
</div>

<script>
(function() {
  const section = document.querySelector('[data-section-id="{{ section.id }}"]');
  if (!section) return;

  function updateModeVisibility() {
    let mode = 'brand-new';
    try {
      const stored = localStorage.getItem('looptech-mode');
      if (stored === 'renewed') mode = 'renewed';
    } catch (e) {}

    const brandNewContent = section.querySelector('[data-mode-content="brand-new"]');
    const renewedContent = section.querySelector('[data-mode-content="renewed"]');

    if (brandNewContent && renewedContent) {
      if (mode === 'renewed') {
        brandNewContent.style.display = 'none';
        renewedContent.style.display = 'block';
      } else {
        brandNewContent.style.display = 'block';
        renewedContent.style.display = 'none';
      }
    }
  }

  // Initial update
  updateModeVisibility();

  // Listen for mode changes
  window.addEventListener('looptech-mode-change', updateModeVisibility);
})();
</script>

{% schema %}
{
  "name": "Recently Viewed Products",
  "class": "shopdev shopdev-recently-viewed-products",
  "tag": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "default": "Pick up where you left off."
    },
    {
      "type": "header",
      "content": "Brand New Products"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Brand New Collection",
      "info": "Collection to display when Brand New mode is active"
    },
    {
      "type": "header",
      "content": "Renewed Products"
    },
    {
      "type": "collection",
      "id": "collection_renewed",
      "label": "Renewed Collection",
      "info": "Collection to display when Renewed mode is active"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding Top",
      "default": 24
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding Bottom",
      "default": 24
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "text",
          "id": "variant_description",
          "label": "Variant Description"
        },
        {
          "type": "checkbox",
          "id": "show_color_swatches",
          "label": "Show Color Swatches",
          "default": true
        },
        {
          "type": "color",
          "id": "color_1",
          "label": "Color Swatch 1"
        },
        {
          "type": "color",
          "id": "color_2",
          "label": "Color Swatch 2"
        },
        {
          "type": "color",
          "id": "color_3",
          "label": "Color Swatch 3"
        },
        {
          "type": "color",
          "id": "color_4",
          "label": "Color Swatch 4"
        },
        {
          "type": "range",
          "id": "additional_colors",
          "min": 0,
          "max": 20,
          "step": 1,
          "label": "Additional Colors Count",
          "default": 4
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Recently Viewed Products",
      "settings": {
        "heading": "Pick up where you left off."
      },
      "blocks": [
        {
          "type": "product",
          "settings": {
            "product": "iphone-16-renewed",
            "variant_description": "Deep Purple - E-Sim + Physical Sim",
            "show_color_swatches": true,
            "color_1": "#000000",
            "color_2": "#C0C0C0",
            "color_3": "#9D98FF",
            "color_4": "#FF0C14",
            "additional_colors": 4
          }
        },
        {
          "type": "product",
          "settings": {
            "product": "iphone-17-renewed",
            "variant_description": "Deep Purple - E-Sim + Physical Sim",
            "show_color_swatches": true,
            "color_1": "#000000",
            "color_2": "#C0C0C0",
            "color_3": "#9D98FF",
            "color_4": "#FF0C14",
            "additional_colors": 4
          }
        },
        {
          "type": "product",
          "settings": {
            "product": "galaxy-s25-ultra-renewed",
            "variant_description": "Deep Purple - E-Sim + Physical Sim",
            "show_color_swatches": true,
            "color_1": "#000000",
            "color_2": "#C0C0C0",
            "color_3": "#9D98FF",
            "color_4": "#FF0C14",
            "additional_colors": 4
          }
        },
        {
          "type": "product",
          "settings": {
            "product": "pixel-10-renewed",
            "variant_description": "Deep Purple - E-Sim + Physical Sim",
            "show_color_swatches": true,
            "color_1": "#000000",
            "color_2": "#C0C0C0",
            "color_3": "#9D98FF",
            "color_4": "#FF0C14",
            "additional_colors": 4
          }
        },
        {
          "type": "product",
          "settings": {
            "product": "nothing-phone-3a-pro-renewed",
            "variant_description": "Deep Purple - E-Sim + Physical Sim",
            "show_color_swatches": true,
            "color_1": "#000000",
            "color_2": "#C0C0C0",
            "color_3": "#9D98FF",
            "color_4": "#FF0C14",
            "additional_colors": 4
          }
        }
      ]
    }
  ]
}
{% endschema %}