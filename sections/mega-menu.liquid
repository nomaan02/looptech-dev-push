{% comment %}
  Enhanced Mega Menu Navigation Section
  - Block-based architecture with Shopify menu integration
  - Assign menus to navigation items with full image control
  - Immediate blur effect response
  - Full customization of dropdown presentation
{% endcomment %}

{{ 'mega-menu.css' | asset_url | stylesheet_tag }}

<style>
  .mega-menu-nav-header {
    position: relative;
    z-index: 50;
    width: 100%;
    border-bottom: 1px solid {{ section.settings.border_color }};
    background-color: {{ section.settings.background_color }};
  }

  /* Top Row Styles */
  .mega-menu-top-row {
    background-color: {{ section.settings.background_color }};
    border-bottom: 1px solid {{ section.settings.border_color }};
  }

  .mega-menu-top-container {
    max-width: 1270px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    gap: 2rem;
    height: 70px;
  }

  @media (min-width: 1024px) {
    .mega-menu-top-container {
      padding: 0.75rem 2rem;
    }
  }

  /* Search Bar Styles */
  .mega-menu-search-wrapper {
    flex: 1;
    max-width: 600px;
    margin: 0 auto;
  }

  .mega-menu-search-form {
    width: 100%;
  }

  .mega-menu-search-field {
    display: flex;
    align-items: center;
    background-color: #f3f4f6;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
  }

  .mega-menu-search-input {
    flex: 1;
    padding: 0.625rem 1rem;
    border: none;
    background: none;
    font-size: 0.875rem;
    outline: none;
    color: {{ section.settings.text_color }};
  }

  .mega-menu-search-input::placeholder {
    color: #9ca3af;
  }

  .mega-menu-search-button {
    padding: 0.625rem 1rem;
    background-color: {{ section.settings.primary_color }};
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
  }

  .mega-menu-search-button:hover {
    opacity: 0.9;
  }

  /* Icons Section */
  .mega-menu-icons-wrapper {
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }

  .mega-menu-icon-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: {{ section.settings.text_color }};
    text-decoration: none;
    transition: color 0.2s;
  }

  .mega-menu-icon-link:hover {
    color: {{ section.settings.primary_color }};
  }

  .mega-menu-cart-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem;
    position: relative;
  }

  .mega-menu-cart-count {
    position: absolute;
    top: -2px;
    right: -8px;
    background-color: {{ section.settings.primary_color }};
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .mega-menu-cart-total {
    font-size: 0.875rem;
    line-height: 1.2;
    text-align: left;
  }

  /* Navigation Container Adjustments */
  .mega-menu-nav-container {
    max-width: 1270px;
    margin: 0 auto;
    display: flex;
    height: {{ section.settings.header_height }}px;
    align-items: center;
    justify-content: space-between;
    padding: 0 1rem;
    gap: 2rem;
    background-color: {{ section.settings.background_color }};
    border-bottom: 1px solid {{ section.settings.border_color }};
  }

  @media (min-width: 1024px) {
    .mega-menu-nav-container {
      padding: 0 2rem;
    }
  }

  /* Logo Section */
  .mega-menu-nav-logo {
    flex-shrink: 0;
  }

  .mega-menu-nav-logo-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: {{ section.settings.logo_font_size }}px;
    font-weight: 700;
    letter-spacing: -0.025em;
    color: {{ section.settings.text_color }};
    text-decoration: none;
  }

  {% if section.settings.logo_image != blank %}
    .mega-menu-nav-logo-image {
      height: {{ section.settings.logo_height }}px;
      width: auto;
    }
  {% endif %}

  .mega-menu-nav-logo-accent {
    color: {{ section.settings.primary_color }};
  }

  /* Main Navigation */
  .mega-menu-nav-main {
    display: none;
    flex: 1;
    align-items: center;
    gap: {{ section.settings.nav_spacing }}px;
  }

  @media (min-width: 1024px) {
    .mega-menu-nav-main {
      display: flex;
    }
  }

  /* Left Section (ALL CATEGORIES) */
  .mega-menu-nav-left {
    display: flex;
    align-items: center;
  }

  /* Center Section (Other Nav Items) */
  .mega-menu-nav-center {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: {{ section.settings.nav_spacing }}px;
    flex: 1;
  }

  /* Nav Item Button/Link */
  .mega-menu-nav-item {
    position: relative;
  }

  .mega-menu-nav-trigger,
  .mega-menu-nav-link {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: {{ section.settings.nav_font_size }}px;
    font-weight: {{ section.settings.nav_font_weight }};
    color: {{ section.settings.nav_text_color }};
    background: none;
    border: none;
    cursor: pointer;
    text-decoration: none;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .mega-menu-nav-trigger:hover,
  .mega-menu-nav-link:hover {
    color: {{ section.settings.primary_color }};
    background-color: {{ section.settings.hover_bg_color }};
  }

  .mega-menu-nav-trigger.active {
    color: {{ section.settings.primary_color }};
  }

  .mega-menu-nav-icon {
    width: 1.25rem;
    height: 1.25rem;
    transition: transform 0.2s;
    flex-shrink: 0;
  }

  .mega-menu-nav-trigger[aria-expanded="true"] .mega-menu-nav-icon:not(:last-child) {
    transform: rotate(180deg);
  }

  /* Mobile Menu Toggle */
  .mega-menu-mobile-toggle {
    display: block;
    padding: 0.5rem;
    background: none;
    border: none;
    cursor: pointer;
    color: {{ section.settings.text_color }};
  }

  @media (min-width: 1024px) {
    .mega-menu-mobile-toggle {
      display: none;
    }
  }

  .mega-menu-mobile-toggle svg {
    width: 1.5rem;
    height: 1.5rem;
  }

  /* Dropdown Panel */
  .mega-menu-nav-dropdown {
    position: absolute;
    left: 0;
    top: 100%;
    width: 100%;
    background-color: {{ section.settings.dropdown_bg_color }};
    border-bottom: 1px solid {{ section.settings.border_color }};
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: opacity 0.15s, transform 0.15s, visibility 0.15s;
    z-index: 100;
    pointer-events: none;
  }

  .mega-menu-nav-dropdown.is-open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    pointer-events: auto;
  }

  .mega-menu-nav-dropdown-inner {
    max-width: 1270px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  @media (min-width: 1024px) {
    .mega-menu-nav-dropdown-inner {
      padding: 2rem;
    }
  }

  /* Dropdown Title */
  .mega-menu-dropdown-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: {{ section.settings.text_color }};
    margin-bottom: 1.5rem;
    text-align: center;
  }

  /* Category Grid */
  .mega-menu-nav-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  @media (min-width: 640px) {
    .mega-menu-nav-grid {
      grid-template-columns: repeat(3, 1fr);
      gap: 1.25rem;
    }
  }

  @media (min-width: 768px) {
    .mega-menu-nav-grid {
      grid-template-columns: repeat(4, 1fr);
      gap: 1.5rem;
    }
  }

  @media (min-width: 1024px) {
    .mega-menu-nav-grid {
      grid-template-columns: repeat({{ section.settings.categories_per_row }}, 1fr);
      gap: 1.5rem;
    }
  }

  /* List Layout */
  .mega-menu-nav-list {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }

  @media (min-width: 768px) {
    .mega-menu-nav-list {
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
    }
  }

  @media (min-width: 1024px) {
    .mega-menu-nav-list {
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
    }
  }

  .mega-menu-nav-list-item {
    padding: 0.75rem 1rem;
    font-size: 0.9375rem;
    font-weight: 500;
    color: {{ section.settings.text_color }};
    text-decoration: none;
    border-radius: 0.375rem;
    transition: all 0.2s;
    display: block;
  }

  .mega-menu-nav-list-item:hover {
    background-color: {{ section.settings.hover_bg_color }};
    color: {{ section.settings.primary_color }};
  }

  /* Category Card */
  .mega-menu-nav-category {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    border-radius: {{ section.settings.card_border_radius }}px;
    text-decoration: none;
    transition: all 0.2s;
    background-color: {{ section.settings.card_bg_color }};
  }

  .mega-menu-nav-category:hover {
    background-color: {{ section.settings.card_hover_bg_color }};
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  .mega-menu-nav-category-image-wrapper {
    aspect-ratio: 1;
    width: 100%;
    overflow: hidden;
    border-radius: {{ section.settings.image_border_radius }}px;
    background-color: {{ section.settings.image_placeholder_bg }};
  }

  .mega-menu-nav-category-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s;
  }

  .mega-menu-nav-category:hover .mega-menu-nav-category-image {
    transform: scale(1.05);
  }

  .mega-menu-nav-category-title {
    font-size: {{ section.settings.category_font_size }}px;
    font-weight: {{ section.settings.category_font_weight }};
    color: {{ section.settings.text_color }};
    text-align: center;
    transition: color 0.2s;
  }

  .mega-menu-nav-category:hover .mega-menu-nav-category-title {
    color: {{ section.settings.primary_color }};
  }

  /* Mobile Menu */
  .mega-menu-nav-mobile {
    display: block;
    position: absolute;
    left: 0;
    top: 100%;
    width: 100%;
    background-color: {{ section.settings.background_color }};
    border-bottom: 1px solid {{ section.settings.border_color }};
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    max-height: 80vh;
    overflow-y: auto;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: opacity 0.2s, transform 0.2s, visibility 0.2s;
  }

  @media (min-width: 1024px) {
    .mega-menu-nav-mobile {
      display: none;
    }
  }

  .mega-menu-nav-mobile.is-open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .mega-menu-nav-mobile-inner {
    padding: 1.5rem 1rem;
  }

  .mega-menu-mobile-nav-item {
    margin-bottom: 1.5rem;
  }

  .mega-menu-mobile-nav-title {
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: {{ section.settings.nav_text_color }};
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid {{ section.settings.primary_color }};
  }

  .mega-menu-mobile-link {
    display: block;
    padding: 0.75rem 0;
    font-size: 0.9375rem;
    font-weight: 500;
    color: {{ section.settings.text_color }};
    text-decoration: none;
    border-bottom: 1px solid {{ section.settings.border_color }};
  }

  /* Blur Overlay */
  .mega-menu-nav-overlay {
    position: fixed;
    inset: 0;
    z-index: 40;
    background-color: rgba(0, 0, 0, {{ section.settings.overlay_opacity | divided_by: 100.0 }});
    backdrop-filter: blur({{ section.settings.blur_amount }}px);
    -webkit-backdrop-filter: blur({{ section.settings.blur_amount }}px);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.15s, visibility 0.15s;
    pointer-events: none;
  }

  .mega-menu-nav-overlay.is-open {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
  }

  /* Content Blur */
  .mega-menu-content-blur {
    transition: filter 0.15s;
  }

  .mega-menu-content-blur.is-blurred {
    filter: blur({{ section.settings.content_blur_amount }}px);
  }

  /* Utilities */
  .mega-menu-hidden {
    display: none !important;
  }

  /* Hover area extension for better UX */
  .mega-menu-nav-item::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 0;
    right: 0;
    height: 10px;
  }
</style>

<!-- Remove page type check to show on all pages -->
<header class="mega-menu-nav-header" data-mega-menu-nav>
  <!-- Top Row: Logo, Search, Icons -->
  <div class="mega-menu-top-row">
    <div class="mega-menu-top-container">
      <!-- Logo -->
      <div class="mega-menu-nav-logo">
        <a href="{{ section.settings.logo_link | default: '/' }}" class="mega-menu-nav-logo-link">
          {% if section.settings.logo_image != blank %}
            {{ section.settings.logo_image | image_url: height: section.settings.logo_height | image_tag: class: 'mega-menu-nav-logo-image', alt: section.settings.logo_text }}
          {% else %}
            {{ section.settings.logo_text }}<span class="mega-menu-nav-logo-accent">{{ section.settings.logo_accent_text }}</span>
          {% endif %}
        </a>
      </div>

      <!-- Search Bar -->
      <div class="mega-menu-search-wrapper">
        <form action="{{ routes.search_url }}" method="get" role="search" class="mega-menu-search-form">
          <div class="mega-menu-search-field">
            <input
              type="search"
              name="q"
              value="{{ search.terms | escape }}"
              placeholder="Search For Products"
              class="mega-menu-search-input"
              aria-label="Search"
            >
            <button type="submit" class="mega-menu-search-button" aria-label="Search">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
              </svg>
            </button>
          </div>
        </form>
      </div>

      <!-- Right Icons (Account & Cart) -->
      <div class="mega-menu-icons-wrapper">
        <!-- Account -->
        <a href="{{ routes.account_url }}" class="mega-menu-icon-link" aria-label="Account">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
        </a>

        <!-- Cart -->
        <a href="{{ routes.cart_url }}" class="mega-menu-icon-link mega-menu-cart-link" aria-label="Cart">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 2 3 9v13h18V9l-6-7z"/>
            <path d="M3 9h18"/>
            <path d="M9 22V9"/>
            <path d="M15 22V9"/>
          </svg>
          <span class="mega-menu-cart-count">{{ cart.item_count }}</span>
          <span class="mega-menu-cart-total">
            Cart<br>
            {{ cart.total_price | money }}
          </span>
        </a>
      </div>
    </div>
  </div>

  <!-- Navigation Row -->
  <div class="mega-menu-nav-container">
    <!-- Desktop Navigation -->
    <nav class="mega-menu-nav-main">
      <!-- Left Section: ALL CATEGORIES -->
      <div class="mega-menu-nav-left">
        {% for block in section.blocks %}
          {% if block.type == 'nav_item' and block.settings.position == 'left' %}
            <div class="mega-menu-nav-item" data-nav-item="{{ block.id }}">
              {% if block.settings.enable_dropdown %}
                <button
                  class="mega-menu-nav-trigger"
                  aria-expanded="false"
                  aria-controls="mega-menu-dropdown-{{ block.id }}"
                  data-nav-trigger="{{ block.id }}"
                >
                  {% if block.settings.show_icon %}
                    <svg class="mega-menu-nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="3" width="7" height="7"/>
                      <rect x="14" y="3" width="7" height="7"/>
                      <rect x="14" y="14" width="7" height="7"/>
                      <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                  {% endif %}
                  {{ block.settings.label }}
                </button>
              {% else %}
                <a href="{{ block.settings.link }}" class="mega-menu-nav-link">
                  {{ block.settings.label }}
                </a>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}
      </div>

      <!-- Center Section: Other Nav Items -->
      <div class="mega-menu-nav-center">
        {% for block in section.blocks %}
          {% if block.type == 'nav_item' and block.settings.position == 'center' %}
            <div class="mega-menu-nav-item" data-nav-item="{{ block.id }}">
              {% if block.settings.enable_dropdown %}
                <button
                  class="mega-menu-nav-trigger"
                  aria-expanded="false"
                  aria-controls="mega-menu-dropdown-{{ block.id }}"
                  data-nav-trigger="{{ block.id }}"
                >
                  {{ block.settings.label }}
                </button>
              {% else %}
                <a href="{{ block.settings.link }}" class="mega-menu-nav-link">
                  {{ block.settings.label }}
                </a>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </nav>

    <!-- Mobile Menu Toggle -->
    <button class="mega-menu-mobile-toggle" aria-label="Toggle menu" data-mobile-toggle>
      <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="4" x2="20" y1="12" y2="12"/>
        <line x1="4" x2="20" y1="6" y2="6"/>
        <line x1="4" x2="20" y1="18" y2="18"/>
      </svg>
      <svg class="close-icon mega-menu-hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M18 6 6 18"/>
        <path d="m6 6 12 12"/>
      </svg>
    </button>
  </div>

  <!-- Desktop Mega Menu Dropdowns -->
  {% for block in section.blocks %}
    {% if block.type == 'nav_item' and block.settings.enable_dropdown %}
      <div
        id="mega-menu-dropdown-{{ block.id }}"
        class="mega-menu-nav-dropdown"
        data-nav-dropdown="{{ block.id }}"
      >
        <div class="mega-menu-nav-dropdown-inner">
          {% if block.settings.dropdown_title != blank %}
            <h3 class="mega-menu-dropdown-title">{{ block.settings.dropdown_title }}</h3>
          {% endif %}

          {% liquid
            assign menu_handle = block.settings.menu
            assign display_style = block.settings.display_style
            assign menu_content = linklists[menu_handle]
          %}

          {% if display_style == 'grid_with_images' %}
            <!-- Grid with Images -->
            <div class="mega-menu-nav-grid">
              {% if menu_content and menu_content.links.size > 0 %}
                {% for link in menu_content.links %}
                  {% liquid
                    # Find matching menu_item block for this link
                    assign link_image = null
                    for menu_item_block in section.blocks
                      if menu_item_block.type == 'menu_item'
                        if menu_item_block.settings.parent_nav_item == block.id
                          if menu_item_block.settings.menu_link_title == link.title or menu_item_block.settings.menu_link_url == link.url
                            assign link_image = menu_item_block.settings.menu_item_image
                            break
                          endif
                        endif
                      endif
                    endfor
                  %}
                  <a href="{{ link.url }}" class="mega-menu-nav-category">
                    <div class="mega-menu-nav-category-image-wrapper">
                      {% if link_image != blank %}
                        {{ link_image | image_url: width: 400 | image_tag: class: 'mega-menu-nav-category-image', loading: 'lazy', alt: link.title }}
                      {% else %}
                        {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
                      {% endif %}
                    </div>
                    <span class="mega-menu-nav-category-title">{{ link.title }}</span>
                  </a>
                {% endfor %}
              {% else %}
                <!-- Fallback to category blocks if no menu assigned -->
                {% for category_block in section.blocks %}
                  {% if category_block.type == 'category' and category_block.settings.parent_nav_item == block.id %}
                    <a href="{{ category_block.settings.category_url }}" class="mega-menu-nav-category">
                      <div class="mega-menu-nav-category-image-wrapper">
                        {% if category_block.settings.category_image != blank %}
                          {{ category_block.settings.category_image | image_url: width: 400 | image_tag: class: 'mega-menu-nav-category-image', loading: 'lazy', alt: category_block.settings.category_title }}
                        {% else %}
                          {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
                        {% endif %}
                      </div>
                      <span class="mega-menu-nav-category-title">{{ category_block.settings.category_title }}</span>
                    </a>
                  {% endif %}
                {% endfor %}
              {% endif %}
            </div>

          {% elsif display_style == 'list' %}
            <!-- Simple List -->
            <div class="mega-menu-nav-list">
              {% if menu_content and menu_content.links.size > 0 %}
                {% for link in menu_content.links %}
                  <a href="{{ link.url }}" class="mega-menu-nav-list-item">{{ link.title }}</a>
                {% endfor %}
              {% else %}
                <!-- Fallback to category blocks -->
                {% for category_block in section.blocks %}
                  {% if category_block.type == 'category' and category_block.settings.parent_nav_item == block.id %}
                    <a href="{{ category_block.settings.category_url }}" class="mega-menu-nav-list-item">{{ category_block.settings.category_title }}</a>
                  {% endif %}
                {% endfor %}
              {% endif %}
            </div>

          {% else %}
            <!-- Default: Grid with Images (same as above) -->
            <div class="mega-menu-nav-grid">
              {% if menu_content and menu_content.links.size > 0 %}
                {% for link in menu_content.links %}
                  {% liquid
                    assign link_image = null
                    for menu_item_block in section.blocks
                      if menu_item_block.type == 'menu_item'
                        if menu_item_block.settings.parent_nav_item == block.id
                          if menu_item_block.settings.menu_link_title == link.title or menu_item_block.settings.menu_link_url == link.url
                            assign link_image = menu_item_block.settings.menu_item_image
                            break
                          endif
                        endif
                      endif
                    endfor
                  %}
                  <a href="{{ link.url }}" class="mega-menu-nav-category">
                    <div class="mega-menu-nav-category-image-wrapper">
                      {% if link_image != blank %}
                        {{ link_image | image_url: width: 400 | image_tag: class: 'mega-menu-nav-category-image', loading: 'lazy', alt: link.title }}
                      {% else %}
                        {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
                      {% endif %}
                    </div>
                    <span class="mega-menu-nav-category-title">{{ link.title }}</span>
                  </a>
                {% endfor %}
              {% else %}
                {% for category_block in section.blocks %}
                  {% if category_block.type == 'category' and category_block.settings.parent_nav_item == block.id %}
                    <a href="{{ category_block.settings.category_url }}" class="mega-menu-nav-category">
                      <div class="mega-menu-nav-category-image-wrapper">
                        {% if category_block.settings.category_image != blank %}
                          {{ category_block.settings.category_image | image_url: width: 400 | image_tag: class: 'mega-menu-nav-category-image', loading: 'lazy', alt: category_block.settings.category_title }}
                        {% else %}
                          {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
                        {% endif %}
                      </div>
                      <span class="mega-menu-nav-category-title">{{ category_block.settings.category_title }}</span>
                    </a>
                  {% endif %}
                {% endfor %}
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>
    {% endif %}
  {% endfor %}

  <!-- Mobile Menu -->
  <div class="mega-menu-nav-mobile" data-mobile-menu>
    <div class="mega-menu-nav-mobile-inner">
      {% for block in section.blocks %}
        {% if block.type == 'nav_item' %}
          <div class="mega-menu-mobile-nav-item">
            {% if block.settings.enable_dropdown %}
              <div class="mega-menu-mobile-nav-title">{{ block.settings.label }}</div>

              {% liquid
                assign menu_handle = block.settings.menu
                assign menu_content = linklists[menu_handle]
              %}

              {% if menu_content and menu_content.links.size > 0 %}
                {% for link in menu_content.links %}
                  <a href="{{ link.url }}" class="mega-menu-mobile-link">{{ link.title }}</a>
                {% endfor %}
              {% else %}
                {% for category_block in section.blocks %}
                  {% if category_block.type == 'category' and category_block.settings.parent_nav_item == block.id %}
                    <a href="{{ category_block.settings.category_url }}" class="mega-menu-mobile-link">
                      {{ category_block.settings.category_title }}
                    </a>
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% else %}
              <a href="{{ block.settings.link }}" class="mega-menu-mobile-link">{{ block.settings.label }}</a>
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
</header>

<!-- Blur Overlay -->
<div class="mega-menu-nav-overlay" data-mega-menu-overlay></div>

<script>
  (function() {
    const header = document.querySelector('[data-mega-menu-nav]');
    if (!header) return;

    const triggers = document.querySelectorAll('[data-nav-trigger]');
    const navItems = document.querySelectorAll('[data-nav-item]');
    const dropdowns = document.querySelectorAll('[data-nav-dropdown]');
    const mobileToggle = document.querySelector('[data-mobile-toggle]');
    const mobileMenu = document.querySelector('[data-mobile-menu]');
    const overlay = document.querySelector('[data-mega-menu-overlay]');
    const menuIcon = mobileToggle?.querySelector('.menu-icon');
    const closeIcon = mobileToggle?.querySelector('.close-icon');

    let activeDropdown = null;
    let isMobileOpen = false;
    let closeTimeoutId = null;
    let isOverNavArea = false;

    // Desktop menu functions
    function openDropdown(triggerId) {
      const trigger = document.querySelector(`[data-nav-trigger="${triggerId}"]`);
      const dropdown = document.querySelector(`[data-nav-dropdown="${triggerId}"]`);

      if (!trigger || !dropdown) return;

      // Clear any pending close
      if (closeTimeoutId) {
        clearTimeout(closeTimeoutId);
        closeTimeoutId = null;
      }

      // Close active dropdown if different
      if (activeDropdown && activeDropdown !== triggerId) {
        closeDropdownImmediate(activeDropdown);
      }

      dropdown.classList.add('is-open');
      trigger.setAttribute('aria-expanded', 'true');
      trigger.classList.add('active');
      overlay.classList.add('is-open');
      blurContent(true);

      activeDropdown = triggerId;
      isOverNavArea = true;
    }

    function closeDropdownImmediate(triggerId) {
      const trigger = document.querySelector(`[data-nav-trigger="${triggerId}"]`);
      const dropdown = document.querySelector(`[data-nav-dropdown="${triggerId}"]`);

      if (!trigger || !dropdown) return;

      dropdown.classList.remove('is-open');
      trigger.setAttribute('aria-expanded', 'false');
      trigger.classList.remove('active');

      if (activeDropdown === triggerId) {
        activeDropdown = null;
        overlay.classList.remove('is-open');
        blurContent(false);
      }
    }

    function closeDropdownDelayed(triggerId) {
      // Small delay to allow moving between trigger and dropdown
      if (closeTimeoutId) {
        clearTimeout(closeTimeoutId);
      }

      closeTimeoutId = setTimeout(() => {
        if (!isOverNavArea) {
          closeDropdownImmediate(triggerId);
        }
        closeTimeoutId = null;
      }, 100);
    }

    function closeAllDropdowns() {
      dropdowns.forEach(dropdown => {
        const triggerId = dropdown.dataset.navDropdown;
        closeDropdownImmediate(triggerId);
      });
      isOverNavArea = false;
    }

    // Mobile menu functions
    function toggleMobileMenu() {
      isMobileOpen = !isMobileOpen;

      if (isMobileOpen) {
        mobileMenu.classList.add('is-open');
        overlay.classList.add('is-open');
        menuIcon?.classList.add('mega-menu-hidden');
        closeIcon?.classList.remove('mega-menu-hidden');
        document.body.style.overflow = 'hidden';
        blurContent(true);
      } else {
        mobileMenu.classList.remove('is-open');
        overlay.classList.remove('is-open');
        menuIcon?.classList.remove('mega-menu-hidden');
        closeIcon?.classList.add('mega-menu-hidden');
        document.body.style.overflow = '';
        blurContent(false);
      }
    }

    function blurContent(blur) {
      const mainContent = document.querySelector('main, .main-content, #MainContent');
      if (mainContent) {
        if (blur) {
          mainContent.classList.add('mega-menu-content-blur', 'is-blurred');
        } else {
          mainContent.classList.remove('mega-menu-content-blur', 'is-blurred');
        }
      }
    }

    // Event listeners for desktop
    triggers.forEach(trigger => {
      const triggerId = trigger.dataset.navTrigger;
      const navItem = trigger.closest('[data-nav-item]');

      // Click to toggle
      trigger.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        if (activeDropdown === triggerId) {
          closeDropdownImmediate(triggerId);
          isOverNavArea = false;
        } else {
          openDropdown(triggerId);
        }
      });

      // Hover to open (desktop only)
      if (window.innerWidth >= 1024) {
        trigger.addEventListener('mouseenter', () => {
          isOverNavArea = true;
          openDropdown(triggerId);
        });

        trigger.addEventListener('mouseleave', () => {
          isOverNavArea = false;
          closeDropdownDelayed(triggerId);
        });

        // Track nav item hover
        if (navItem) {
          navItem.addEventListener('mouseenter', () => {
            isOverNavArea = true;
          });

          navItem.addEventListener('mouseleave', () => {
            isOverNavArea = false;
            closeDropdownDelayed(triggerId);
          });
        }
      }
    });

    // Keep dropdown open when hovering over it
    dropdowns.forEach(dropdown => {
      const triggerId = dropdown.dataset.navDropdown;

      dropdown.addEventListener('mouseenter', () => {
        isOverNavArea = true;
        if (closeTimeoutId) {
          clearTimeout(closeTimeoutId);
          closeTimeoutId = null;
        }
      });

      dropdown.addEventListener('mouseleave', (e) => {
        isOverNavArea = false;

        // Check if mouse left to go back to trigger
        const relatedTarget = e.relatedTarget;
        const trigger = document.querySelector(`[data-nav-trigger="${triggerId}"]`);
        const navItem = trigger?.closest('[data-nav-item]');

        if (relatedTarget && navItem && navItem.contains(relatedTarget)) {
          isOverNavArea = true;
          return;
        }

        // Immediately close if leaving dropdown area completely
        closeDropdownImmediate(triggerId);
      });
    });

    // Header-level tracking
    header.addEventListener('mouseleave', (e) => {
      // Check if we're truly leaving the header area
      const rect = header.getBoundingClientRect();
      const mouseY = e.clientY;

      if (mouseY < rect.top || mouseY > rect.bottom + 20) {
        isOverNavArea = false;
        if (activeDropdown) {
          closeDropdownImmediate(activeDropdown);
        }
      }
    });

    // Mobile toggle
    if (mobileToggle) {
      mobileToggle.addEventListener('click', toggleMobileMenu);
    }

    // Overlay click - immediate close
    if (overlay) {
      overlay.addEventListener('click', () => {
        closeAllDropdowns();
        if (isMobileOpen) toggleMobileMenu();
      });
    }

    // Escape key - immediate close
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeAllDropdowns();
        if (isMobileOpen) toggleMobileMenu();
      }
    });

    // Close on window resize
    window.addEventListener('resize', () => {
      if (window.innerWidth >= 1024 && isMobileOpen) {
        toggleMobileMenu();
      }
    });

    // Close dropdowns when scrolling
    let scrollTimeout;
    window.addEventListener('scroll', () => {
      if (activeDropdown) {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          if (activeDropdown && window.scrollY > 50) {
            closeAllDropdowns();
          }
        }, 100);
      }
    });
  })();
</script>

{% schema %}
{
  "name": "Mega Menu Navigation",
  "tag": "section",
  "class": "mega-menu-nav-section",
  "settings": [
    {
      "type": "header",
      "content": "Logo Settings"
    },
    {
      "type": "image_picker",
      "id": "logo_image",
      "label": "Logo Image",
      "info": "Leave empty to use text logo"
    },
    {
      "type": "range",
      "id": "logo_height",
      "min": 20,
      "max": 100,
      "step": 2,
      "unit": "px",
      "label": "Logo Height",
      "default": 40
    },
    {
      "type": "text",
      "id": "logo_text",
      "label": "Logo Text (Part 1)",
      "default": "TECH"
    },
    {
      "type": "text",
      "id": "logo_accent_text",
      "label": "Logo Text (Part 2 - Accent)",
      "default": "STORE"
    },
    {
      "type": "range",
      "id": "logo_font_size",
      "min": 14,
      "max": 32,
      "step": 1,
      "unit": "px",
      "label": "Logo Font Size",
      "default": 20
    },
    {
      "type": "url",
      "id": "logo_link",
      "label": "Logo Link",
      "default": "/"
    },
    {
      "type": "header",
      "content": "Header Settings"
    },
    {
      "type": "range",
      "id": "header_height",
      "min": 50,
      "max": 120,
      "step": 2,
      "unit": "px",
      "label": "Header Height",
      "default": 64
    },
    {
      "type": "header",
      "content": "Navigation Settings"
    },
    {
      "type": "range",
      "id": "nav_font_size",
      "min": 12,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Navigation Font Size",
      "default": 14
    },
    {
      "type": "select",
      "id": "nav_font_weight",
      "label": "Navigation Font Weight",
      "options": [
        { "value": "400", "label": "Normal" },
        { "value": "500", "label": "Medium" },
        { "value": "600", "label": "Semi Bold" },
        { "value": "700", "label": "Bold" }
      ],
      "default": "500"
    },
    {
      "type": "range",
      "id": "nav_spacing",
      "min": 8,
      "max": 48,
      "step": 4,
      "unit": "px",
      "label": "Navigation Item Spacing",
      "default": 16
    },
    {
      "type": "header",
      "content": "Dropdown Settings"
    },
    {
      "type": "range",
      "id": "categories_per_row",
      "min": 3,
      "max": 8,
      "step": 1,
      "label": "Categories Per Row (Desktop)",
      "default": 6
    },
    {
      "type": "range",
      "id": "category_font_size",
      "min": 12,
      "max": 18,
      "step": 1,
      "unit": "px",
      "label": "Category Title Font Size",
      "default": 14
    },
    {
      "type": "select",
      "id": "category_font_weight",
      "label": "Category Title Font Weight",
      "options": [
        { "value": "400", "label": "Normal" },
        { "value": "500", "label": "Medium" },
        { "value": "600", "label": "Semi Bold" },
        { "value": "700", "label": "Bold" }
      ],
      "default": "500"
    },
    {
      "type": "range",
      "id": "card_border_radius",
      "min": 0,
      "max": 24,
      "step": 2,
      "unit": "px",
      "label": "Card Border Radius",
      "default": 8
    },
    {
      "type": "range",
      "id": "image_border_radius",
      "min": 0,
      "max": 24,
      "step": 2,
      "unit": "px",
      "label": "Image Border Radius",
      "default": 8
    },
    {
      "type": "header",
      "content": "Blur Effect Settings"
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "min": 0,
      "max": 80,
      "step": 5,
      "unit": "%",
      "label": "Overlay Opacity",
      "default": 20
    },
    {
      "type": "range",
      "id": "blur_amount",
      "min": 0,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Overlay Blur Amount",
      "default": 4
    },
    {
      "type": "range",
      "id": "content_blur_amount",
      "min": 0,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Content Blur Amount",
      "default": 4
    },
    {
      "type": "header",
      "content": "Color Settings"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Header Background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#0f172a"
    },
    {
      "type": "color",
      "id": "nav_text_color",
      "label": "Navigation Text Color",
      "default": "#64748b"
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Primary/Accent Color",
      "default": "#0f172a"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border Color",
      "default": "#e2e8f0"
    },
    {
      "type": "color",
      "id": "hover_bg_color",
      "label": "Navigation Hover Background",
      "default": "#f1f5f9"
    },
    {
      "type": "color",
      "id": "dropdown_bg_color",
      "label": "Dropdown Background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "card_bg_color",
      "label": "Category Card Background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "card_hover_bg_color",
      "label": "Category Card Hover Background",
      "default": "#f8fafc"
    },
    {
      "type": "color",
      "id": "image_placeholder_bg",
      "label": "Image Placeholder Background",
      "default": "#f1f5f9"
    }
  ],
  "blocks": [
    {
      "type": "nav_item",
      "name": "Navigation Item",
      "settings": [
        {
          "type": "text",
          "id": "label",
          "label": "Label",
          "default": "Menu Item"
        },
        {
          "type": "select",
          "id": "position",
          "label": "Position",
          "options": [
            { "value": "left", "label": "Left (ALL CATEGORIES area)" },
            { "value": "center", "label": "Center (Main navigation)" }
          ],
          "default": "center",
          "info": "Choose where this item appears in the navigation"
        },
        {
          "type": "checkbox",
          "id": "enable_dropdown",
          "label": "Enable Mega Menu Dropdown",
          "default": false,
          "info": "If enabled, this item will show a dropdown with menu items"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link",
          "info": "Only used if dropdown is disabled"
        },
        {
          "type": "header",
          "content": "Dropdown Content"
        },
        {
          "type": "link_list",
          "id": "menu",
          "label": "Menu",
          "info": "Select a Shopify menu to display in the dropdown. Create menus in Navigation settings."
        },
        {
          "type": "select",
          "id": "display_style",
          "label": "Display Style",
          "options": [
            { "value": "grid_with_images", "label": "Grid with Images" },
            { "value": "list", "label": "Simple List (no images)" }
          ],
          "default": "grid_with_images",
          "info": "Choose how menu items are displayed"
        },
        {
          "type": "text",
          "id": "dropdown_title",
          "label": "Dropdown Title",
          "info": "Optional title shown at top of dropdown"
        },
        {
          "type": "checkbox",
          "id": "show_icon",
          "label": "Show Grid Icon",
          "default": false,
          "info": "Show a grid icon before the label (typically for ALL CATEGORIES)"
        }
      ]
    },
    {
      "type": "menu_item",
      "name": "Menu Item Image",
      "settings": [
        {
          "type": "text",
          "id": "parent_nav_item",
          "label": "Parent Navigation Item ID",
          "info": "Enter the ID of the navigation item this image belongs to"
        },
        {
          "type": "text",
          "id": "menu_link_title",
          "label": "Menu Link Title",
          "info": "Enter the EXACT title of the menu link (case-sensitive)"
        },
        {
          "type": "url",
          "id": "menu_link_url",
          "label": "Menu Link URL (Optional)",
          "info": "Alternative: Enter the URL to match if title matching doesn't work"
        },
        {
          "type": "image_picker",
          "id": "menu_item_image",
          "label": "Image",
          "info": "Upload an image for this menu item (recommended: 400x400px square)"
        }
      ]
    },
    {
      "type": "category",
      "name": "Category (Legacy)",
      "settings": [
        {
          "type": "paragraph",
          "content": "⚠️ This block type is deprecated. Use 'Navigation Item' with a menu and 'Menu Item Image' blocks instead."
        },
        {
          "type": "text",
          "id": "parent_nav_item",
          "label": "Parent Navigation Item ID",
          "info": "Enter the ID of the navigation item this category belongs to"
        },
        {
          "type": "text",
          "id": "category_title",
          "label": "Category Title",
          "default": "Category"
        },
        {
          "type": "url",
          "id": "category_url",
          "label": "Category Link"
        },
        {
          "type": "image_picker",
          "id": "category_image",
          "label": "Category Image",
          "info": "Recommended: Square image, at least 400x400px"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Mega Menu Navigation",
      "blocks": [
        {
          "type": "nav_item",
          "settings": {
            "label": "ALL CATEGORIES",
            "position": "left",
            "enable_dropdown": true,
            "show_icon": true,
            "dropdown_title": "Browse All Categories",
            "display_style": "grid_with_images"
          }
        },
        {
          "type": "nav_item",
          "settings": {
            "label": "LAPTOPS",
            "position": "center",
            "enable_dropdown": true,
            "dropdown_title": "Shop Laptops",
            "display_style": "grid_with_images"
          }
        },
        {
          "type": "nav_item",
          "settings": {
            "label": "DESKTOP PCs",
            "position": "center",
            "enable_dropdown": true,
            "dropdown_title": "Shop Desktop PCs",
            "display_style": "grid_with_images"
          }
        },
        {
          "type": "nav_item",
          "settings": {
            "label": "GAMING PCs",
            "position": "center",
            "enable_dropdown": true,
            "dropdown_title": "Shop Gaming PCs",
            "display_style": "grid_with_images"
          }
        },
        {
          "type": "nav_item",
          "settings": {
            "label": "ACCESSORIES",
            "position": "center",
            "enable_dropdown": true,
            "dropdown_title": "Shop Accessories",
            "display_style": "grid_with_images"
          }
        },
        {
          "type": "nav_item",
          "settings": {
            "label": "ABOUT US",
            "position": "center",
            "enable_dropdown": false,
            "link": "/pages/about"
          }
        },
        {
          "type": "nav_item",
          "settings": {
            "label": "CONTACT",
            "position": "center",
            "enable_dropdown": false,
            "link": "/pages/contact"
          }
        }
      ]
    }
  ]
}
{% endschema %}
