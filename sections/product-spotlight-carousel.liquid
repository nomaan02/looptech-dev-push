{%- comment -%}
  Product carousel with brand tabs - styled like Back Market
  includes logo tabs and nice product cards

  SKU-Based Filtering:
  Products are filtered based on their SKU condition code (4th segment):
  - Brand New mode: Shows products with 'NEW' condition
  - Renewed mode: Shows products with 'REN' condition
{%- endcomment -%}

{%- comment -%}
  INLINE MODE DETECTION - DO NOT use render 'detect-current-mode'
  Liquid's render tag creates isolated variable scope.
{%- endcomment -%}
{%- liquid
  assign current_mode = 'brand-new'
  assign has_url_mode = false
  assign url_string = request.url | downcase

  if url_string contains 'mode=renewed'
    assign current_mode = 'renewed'
    assign has_url_mode = true
  elsif url_string contains 'mode=brand-new'
    assign current_mode = 'brand-new'
    assign has_url_mode = true
  elsif url_string contains 'mode=new'
    assign current_mode = 'brand-new'
    assign has_url_mode = true
  endif
-%}

{%- liquid
  # Select collection based on mode
  if current_mode == 'renewed' and section.settings.featured_collection_renewed != blank
    assign featured_collection = section.settings.featured_collection_renewed
  else
    assign featured_collection = section.settings.featured_collection
  endif
  assign hero_image = section.settings.hero_image
  assign hero_position = section.settings.hero_position
  assign section_heading = section.settings.section_heading
  assign products_limit = section.settings.products_limit
  assign show_ratings = section.settings.show_ratings
  assign show_starting_at_text = section.settings.show_starting_at_text
  assign show_new_price_comparison = section.settings.show_new_price_comparison
  assign left_column_width = section.settings.left_column_width
  assign carousel_bg_color = section.settings.carousel_background_color
  assign section_height = section.settings.section_height
  assign desktop_column_layout = section.settings.desktop_column_layout
  assign mobile_column_layout = section.settings.mobile_column_layout
  assign desktop_show_hero = section.settings.desktop_show_hero
  assign mobile_show_hero = section.settings.mobile_show_hero

  # Mobile-specific customization settings
  assign mobile_card_width_percent = section.settings.mobile_card_width_percent
  assign mobile_card_height = section.settings.mobile_card_height
  assign mobile_product_image_height = section.settings.mobile_product_image_height
  assign mobile_card_padding = section.settings.mobile_card_padding
  assign mobile_nav_tab_height = section.settings.mobile_nav_tab_height
  assign mobile_nav_tab_padding = section.settings.mobile_nav_tab_padding
  assign mobile_nav_tab_spacing = section.settings.mobile_nav_tab_spacing
  assign mobile_nav_icon_size = section.settings.mobile_nav_icon_size


  # defaults if nothing is set
  if section_heading == blank
    assign section_heading = ''
  endif

  if products_limit == blank
    assign products_limit = 12
  endif

  if show_ratings == nil
    assign show_ratings = true
  endif

  if show_starting_at_text == nil
    assign show_starting_at_text = true
  endif

  if show_new_price_comparison == nil
    assign show_new_price_comparison = false
  endif

  if hero_position == blank
    assign hero_position = 'left'
  endif

  if left_column_width == blank
    assign left_column_width = 30
  endif

  if carousel_bg_color == blank
    assign carousel_bg_color = '#ffffff'
  endif


  if section_height == blank
    assign section_height = 600
  endif

  if desktop_column_layout == blank
    assign desktop_column_layout = 'two-column'
  endif

  if mobile_column_layout == blank
    assign mobile_column_layout = 'single-column'
  endif

  # Mobile customization defaults
  if mobile_card_width_percent == blank
    assign mobile_card_width_percent = 70
  endif

  if mobile_card_height == blank
    assign mobile_card_height = 420
  endif

  if mobile_product_image_height == blank
    assign mobile_product_image_height = 250
  endif

  if mobile_card_padding == blank
    assign mobile_card_padding = 12
  endif

  if mobile_nav_tab_height == blank
    assign mobile_nav_tab_height = 36
  endif

  if mobile_nav_tab_padding == blank
    assign mobile_nav_tab_padding = 16
  endif

  if mobile_nav_tab_spacing == blank
    assign mobile_nav_tab_spacing = 8
  endif

  if mobile_nav_icon_size == blank
    assign mobile_nav_icon_size = 18
  endif


  assign right_column_width = 100 | minus: left_column_width
  
  # pull in products from the selected collection
  if featured_collection != blank
    assign collection_products = collections[featured_collection].products
  endif
-%}

{%- if featured_collection != blank -%}
<div class="product-spotlight-section"
     data-section-id="{{ section.id }}"
     data-section-height="{{ section_height }}"
     data-desktop-layout="{{ desktop_column_layout }}"
     data-mobile-layout="{{ mobile_column_layout }}"
     data-desktop-show-hero="{{ desktop_show_hero }}"
     data-mobile-show-hero="{{ mobile_show_hero }}"
     data-mobile-card-width="{{ mobile_card_width_percent }}"
     data-mobile-card-height="{{ mobile_card_height }}"
     data-mobile-image-height="{{ mobile_product_image_height }}"
     data-mobile-card-padding="{{ mobile_card_padding }}"
     data-mobile-card-spacing="{{ section.settings.mobile_card_spacing }}"
     data-mobile-nav-height="{{ mobile_nav_tab_height }}"
     data-mobile-nav-padding="{{ mobile_nav_tab_padding }}"
     data-mobile-nav-spacing="{{ mobile_nav_tab_spacing }}"
     data-mobile-icon-size="{{ mobile_nav_icon_size }}">

  {%- # section heading above the carousel -%}
  {%- if section_heading != blank -%}
    <div class="spotlight-heading-container" style="max-width: 1270px; margin: 0 auto; padding: 0 16px;">
      <h2 class="spotlight-section-heading">
        {{ section_heading }}
      </h2>
    </div>
  {%- endif -%}

  <div class="spotlight-container">
    <div class="spotlight-layout" data-hero-position="{{ hero_position }}">
      
      {%- if hero_position == 'right' -%}
        {%- # carousel goes on the left when hero is on right -%}
        <div class="carousel-column">

          {%- # brand tabs for filtering collections -%}
          {%- if section.blocks.size > 0 -%}
            <div class="brand-navigation-bar" role="tablist" aria-label="Product collections">
              
              {%- # default "show all" tab -%}
              <button
                type="button"
                class="brand-tab-pill active" 
                data-filter="all" 
                data-collection="{{ featured_collection }}"
                role="tab"
                aria-selected="true"
                aria-controls="carousel-{{ section.id }}"
              >
                <span class="brand-tab-icon">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="3" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2"/>
                    <rect x="14" y="3" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2"/>
                    <rect x="3" y="14" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2"/>
                    <rect x="14" y="14" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2"/>
                  </svg>
                </span>
                <span class="brand-tab-label">All Products</span>
              </button>

              {%- # loop through brand blocks from theme editor -%}
              {%- for block in section.blocks -%}
                {%- if block.type == 'brand_tab' and block.settings.collection != blank -%}
                  <button
                    type="button"
                    class="brand-tab-pill" 
                    data-filter="{{ block.settings.collection }}"
                    data-collection="{{ block.settings.collection }}"
                    role="tab"
                    aria-selected="false"
                    aria-controls="carousel-{{ section.id }}"
                    {{ block.shopify_attributes }}
                  >
                    <span class="brand-tab-icon">
                      {%- if block.settings.brand_logo != blank -%}
                        {%- assign brand_logo_alt = block.settings.brand_name | escape -%}
                        {{
                          block.settings.brand_logo |
                          image_url: width: 60 |
                          image_tag:
                            loading: 'lazy',
                            widths: '30, 60',
                            alt: brand_logo_alt,
                            class: 'brand-tab-logo'
                        }}
                      {%- else -%}
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                          <circle cx="12" cy="12" r="4" fill="currentColor"/>
                        </svg>
                      {%- endif -%}
                    </span>
                    <span class="brand-tab-label">{{ block.settings.brand_name | escape }}</span>
                  </button>
                {%- endif -%}
              {%- endfor -%}

            </div>
          {%- endif -%}

          {%- # actual product carousel -%}
          <div class="carousel-wrapper">
            <div class="carousel-container" id="carousel-{{ section.id }}">
              
              {%- # prev/next arrows -%}
              <button class="carousel-arrow carousel-arrow--prev" aria-label="Previous products" disabled>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>

              <button class="carousel-arrow carousel-arrow--next" aria-label="Next products">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>

              {%- # track holds all the products, gradient overlay fades the right edge -%}
              <div class="carousel-track-container">
                <div class="carousel-track" data-collection="all" data-mode="{{ current_mode }}">
                  {%- if collection_products.size > 0 -%}
                    {%- liquid
                      # Filter products by SKU condition based on current mode
                      assign displayed_count = 0
                    -%}
                    {%- for product in collection_products -%}
                      {%- liquid
                        # Parse SKU to check condition
                        render 'sku-parser', sku: product.variants.first.sku
                        assign should_display = false

                        if sku_is_valid
                          # Check if product SKU matches current mode
                          if current_mode == 'brand-new' and sku_condition == 'NEW'
                            assign should_display = true
                          elsif current_mode == 'renewed' and sku_condition == 'REN'
                            assign should_display = true
                          endif
                        else
                          # Fallback for products without proper SKU - show in both modes
                          assign should_display = true
                        endif
                      -%}

                      {%- if should_display and displayed_count < products_limit -%}
                        {%- render 'product-spotlight-card',
                          product: product,
                          show_rating: show_ratings,
                          show_starting_at: show_starting_at_text,
                          show_new_price: show_new_price_comparison,
                          section_id: section.id
                        -%}
                        {%- assign displayed_count = displayed_count | plus: 1 -%}
                      {%- endif -%}
                    {%- endfor -%}

                    {%- if displayed_count == 0 -%}
                      <div class="carousel-empty">
                        <p>No {{ current_mode }} products available in this collection.</p>
                      </div>
                    {%- endif -%}
                  {%- else -%}
                    <div class="carousel-empty">
                      <p>No products available in this collection.</p>
                    </div>
                  {%- endif -%}
                </div>
                
                {%- # gradient fade on the right edge -%}
                <div class="carousel-fade-overlay" aria-hidden="true"></div>
              </div>

            </div>

            {%- # page dots below carousel -%}
            {%- if collection_products.size > 3 -%}
              <div class="carousel-dots" role="tablist" aria-label="Carousel navigation">
                {%- # dots get created by JS -%}
              </div>
            {%- endif -%}

          </div>

        </div>

        {%- # hero image on the right side -%}
        <div class="hero-column">
          {%- if hero_image != blank -%}
            {%- assign hero_alt = hero_image.alt | default: section_heading | escape -%}
            {{
              hero_image |
              image_url: width: 800 |
              image_tag:
                loading: 'lazy',
                widths: '400, 600, 800',
                sizes: '(min-width: 1200px) 500px, (min-width: 768px) 40vw, 100vw',
                alt: hero_alt,
                class: 'hero-image'
            }}
          {%- else -%}
            <div class="hero-placeholder">
              {{ 'lifestyle-1' | placeholder_svg_tag: 'placeholder-svg' }}
            </div>
          {%- endif -%}
        </div>

      {%- else -%}
        {%- # default: hero image on the left side -%}
        <div class="hero-column">
          {%- if hero_image != blank -%}
            {%- assign hero_alt = hero_image.alt | default: section_heading | escape -%}
            {{
              hero_image |
              image_url: width: 800 |
              image_tag:
                loading: 'lazy',
                widths: '400, 600, 800',
                sizes: '(min-width: 1200px) 500px, (min-width: 768px) 40vw, 100vw',
                alt: hero_alt,
                class: 'hero-image'
            }}
          {%- else -%}
            <div class="hero-placeholder">
              {{ 'lifestyle-1' | placeholder_svg_tag: 'placeholder-svg' }}
            </div>
          {%- endif -%}
        </div>

        {%- # carousel goes on the right -%}
        <div class="carousel-column">

          {%- # brand tabs for filtering collections -%}
          {%- if section.blocks.size > 0 -%}
            <div class="brand-navigation-bar" role="tablist" aria-label="Product collections">
              
              {%- # default "show all" tab -%}
              <button
                type="button"
                class="brand-tab-pill active" 
                data-filter="all" 
                data-collection="{{ featured_collection }}"
                role="tab"
                aria-selected="true"
                aria-controls="carousel-{{ section.id }}"
              >
                <span class="brand-tab-icon">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="3" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2"/>
                    <rect x="14" y="3" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2"/>
                    <rect x="3" y="14" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2"/>
                    <rect x="14" y="14" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2"/>
                  </svg>
                </span>
                <span class="brand-tab-label">All Products</span>
              </button>

              {%- # loop through brand blocks from theme editor -%}
              {%- for block in section.blocks -%}
                {%- if block.type == 'brand_tab' and block.settings.collection != blank -%}
                  <button
                    type="button"
                    class="brand-tab-pill" 
                    data-filter="{{ block.settings.collection }}"
                    data-collection="{{ block.settings.collection }}"
                    role="tab"
                    aria-selected="false"
                    aria-controls="carousel-{{ section.id }}"
                    {{ block.shopify_attributes }}
                  >
                    <span class="brand-tab-icon">
                      {%- if block.settings.brand_logo != blank -%}
                        {%- assign brand_logo_alt = block.settings.brand_name | escape -%}
                        {{
                          block.settings.brand_logo |
                          image_url: width: 60 |
                          image_tag:
                            loading: 'lazy',
                            widths: '30, 60',
                            alt: brand_logo_alt,
                            class: 'brand-tab-logo'
                        }}
                      {%- else -%}
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                          <circle cx="12" cy="12" r="4" fill="currentColor"/>
                        </svg>
                      {%- endif -%}
                    </span>
                    <span class="brand-tab-label">{{ block.settings.brand_name | escape }}</span>
                  </button>
                {%- endif -%}
              {%- endfor -%}

            </div>
          {%- endif -%}

          {%- # actual product carousel -%}
          <div class="carousel-wrapper">
            <div class="carousel-container" id="carousel-{{ section.id }}">
              
              {%- # prev/next arrows -%}
              <button class="carousel-arrow carousel-arrow--prev" aria-label="Previous products" disabled>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>

              <button class="carousel-arrow carousel-arrow--next" aria-label="Next products">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>

              {%- # track holds all the products, gradient overlay fades the right edge -%}
              <div class="carousel-track-container">
                <div class="carousel-track" data-collection="all" data-mode="{{ current_mode }}">
                  {%- if collection_products.size > 0 -%}
                    {%- liquid
                      # Filter products by SKU condition based on current mode
                      assign displayed_count = 0
                    -%}
                    {%- for product in collection_products -%}
                      {%- liquid
                        # Parse SKU to check condition
                        render 'sku-parser', sku: product.variants.first.sku
                        assign should_display = false

                        if sku_is_valid
                          # Check if product SKU matches current mode
                          if current_mode == 'brand-new' and sku_condition == 'NEW'
                            assign should_display = true
                          elsif current_mode == 'renewed' and sku_condition == 'REN'
                            assign should_display = true
                          endif
                        else
                          # Fallback for products without proper SKU - show in both modes
                          assign should_display = true
                        endif
                      -%}

                      {%- if should_display and displayed_count < products_limit -%}
                        {%- render 'product-spotlight-card',
                          product: product,
                          show_rating: show_ratings,
                          show_starting_at: show_starting_at_text,
                          show_new_price: show_new_price_comparison,
                          section_id: section.id
                        -%}
                        {%- assign displayed_count = displayed_count | plus: 1 -%}
                      {%- endif -%}
                    {%- endfor -%}
                    
                    

                    {%- if displayed_count == 0 -%}
                      <div class="carousel-empty">
                        <p>No {{ current_mode }} products available in this collection.</p>
                      </div>
                    {%- endif -%}
                  {%- else -%}
                    <div class="carousel-empty">
                      <p>No products available in this collection.</p>
                    </div>
                  {%- endif -%}
                </div>
                
                {%- # gradient fade on the right edge -%}
                <div class="carousel-fade-overlay" aria-hidden="true"></div>
              </div>

            </div>

            {%- # page dots below carousel -%}
            {%- if collection_products.size > 3 -%}
              <div class="carousel-dots" role="tablist" aria-label="Carousel navigation">
                {%- # dots get created by JS -%}
              </div>
            {%- endif -%}

          </div>

        </div>
      {%- endif -%}

    </div>
  </div>
</div>
{%- else -%}
  <div class="spotlight-placeholder">
    <p>Please select a collection in the theme editor to display products.</p>
  </div>
{%- endif -%}

<style>
/* ============================================
   Product Spotlight Carousel
   styled like Back Market's design
   ============================================ */

#shopify-section-{{ section.id }} .product-spotlight-section {
  width: 100%;
  padding: {{ section.settings.padding_top }}px 16px {{ section.settings.padding_bottom }}px;
  background-color: transparent;
}

@media (min-width: 768px) {
  #shopify-section-{{ section.id }} .product-spotlight-section {
    padding: {{ section.settings.padding_top }}px 24px {{ section.settings.padding_bottom }}px;
  }
}

#shopify-section-{{ section.id }} .spotlight-section-heading {
  color: #0A0A0A;
  font-weight: 700;
  font-size: 20px;
  line-height: 30px;
  margin-bottom: 24px;
}

/* Responsive heading container padding - standardized with site design */
#shopify-section-{{ section.id }} .spotlight-heading-container {
  padding: 0 !important;
}

#shopify-section-{{ section.id }} .spotlight-container {
  max-width: 1270px;
  margin: 0 auto;
  background-color: #ffffff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

/* ============================================
   Section Height Control
   ============================================ */

#shopify-section-{{ section.id }} .product-spotlight-section[data-section-height] .spotlight-layout {
  min-height: var(--section-height, 600px);
  height: var(--section-height, 600px);
}

/* ============================================
   two column layout grid
   left = hero image, right = carousel
   ============================================ */

#shopify-section-{{ section.id }} .spotlight-layout {
  display: grid;
  gap: 0;
  min-height: 350px;
}

/* Desktop Column Layout Control */
@media (min-width: 768px) {
  /* Desktop: Single column layout (carousel only) */
  #shopify-section-{{ section.id }} .product-spotlight-section[data-desktop-layout="single-column"] .spotlight-layout {
    grid-template-columns: 100%;
  }

  #shopify-section-{{ section.id }} .product-spotlight-section[data-desktop-layout="single-column"] .hero-column {
    display: none;
  }

  /* Desktop: Two column layout (default) */
  #shopify-section-{{ section.id }} .product-spotlight-section[data-desktop-layout="two-column"] .spotlight-layout {
    grid-template-columns: {{ left_column_width }}% {{ right_column_width }}%;
  }

  /* Hide hero if desktop_show_hero is false */
  #shopify-section-{{ section.id }} .product-spotlight-section[data-desktop-show-hero="false"] .hero-column {
    display: none;
  }

  #shopify-section-{{ section.id }} .product-spotlight-section[data-desktop-show-hero="false"][data-desktop-layout="two-column"] .spotlight-layout {
    grid-template-columns: 100%;
  }
}

/* default: hero on left */
#shopify-section-{{ section.id }} .spotlight-layout[data-hero-position="left"] {
  grid-template-columns: {{ left_column_width }}% {{ right_column_width }}%;
}

/* when hero on right, swap the column widths */
#shopify-section-{{ section.id }} .spotlight-layout[data-hero-position="right"] {
  grid-template-columns: {{ right_column_width }}% {{ left_column_width }}%;
}

/* hero image column - desktop visibility control */
#shopify-section-{{ section.id }} .hero-column {
  position: relative;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  overflow: hidden;
}

/* Desktop hero visibility */
@media (min-width: 768px) {
  #shopify-section-{{ section.id }} .hero-column {
    display: {% if section.settings.desktop_show_hero %}block{% else %}none{% endif %};
  }

  /* Adjust grid when hero is hidden on desktop */
  {% unless section.settings.desktop_show_hero %}
    #shopify-section-{{ section.id }} .spotlight-layout[data-hero-position="left"],
    #shopify-section-{{ section.id }} .spotlight-layout[data-hero-position="right"] {
      grid-template-columns: 1fr;
    }
  {% endunless %}
}

#shopify-section-{{ section.id }} .hero-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  object-position: center;
  display: block;
}

#shopify-section-{{ section.id }} .hero-placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

#shopify-section-{{ section.id }} .hero-placeholder svg {
  width: 50%;
  height: 50%;
  opacity: 0.3;
}

/* carousel column on the right */
#shopify-section-{{ section.id }} .carousel-column {
  padding: 40px 0px;
  display: flex;
  flex-direction: column;
  gap: 24px;
  background-color: {{ carousel_bg_color }};
}

/* ============================================
   Brand Tab Pills - Clean, Content-Hugging Design
   Horizontal scrolling pills with icon + label
   ============================================ */

#shopify-section-{{ section.id }} .brand-navigation-bar {
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: flex-start;
  flex-wrap: nowrap;
  overflow-x: auto;
  overflow-y: hidden;
  scrollbar-width: none;
  -ms-overflow-style: none;
  padding: 16px 24px;
  margin: 0;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
}

#shopify-section-{{ section.id }} .brand-navigation-bar::-webkit-scrollbar {
  display: none;
}

/* Brand Tab Pill - The main button element */
#shopify-section-{{ section.id }} .brand-tab-pill {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  min-height: 44px;
  padding: 10px 20px;
  background: #ffffff;
  border: 1.5px solid #e5e7eb;
  border-radius: 999px;
  cursor: pointer;
  transition: all 0.2s ease;
  flex-shrink: 0;
  white-space: nowrap;
  font-family: inherit;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
}

#shopify-section-{{ section.id }} .brand-tab-pill:hover {
  border-color: #3b82f6;
  background: #f8fafc;
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.12);
}

#shopify-section-{{ section.id }} .brand-tab-pill:focus {
  outline: 2px solid #3b82f6;
  outline-offset: 2px;
}

#shopify-section-{{ section.id }} .brand-tab-pill.active {
  border-color: #3b82f6;
  background: #eff6ff;
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
}

/* Icon container - fixed size, centered */
#shopify-section-{{ section.id }} .brand-tab-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  flex: 0 0 22px;
  width: 22px;
  height: 22px;
}

/* SVG icons */
#shopify-section-{{ section.id }} .brand-tab-icon svg {
  width: 22px;
  height: 22px;
  color: #6b7280;
  transition: color 0.2s ease;
}

#shopify-section-{{ section.id }} .brand-tab-pill.active .brand-tab-icon svg {
  color: #3b82f6;
}

/* Brand logo images */
#shopify-section-{{ section.id }} .brand-tab-logo {
  width: 22px;
  height: 22px;
  object-fit: contain;
  object-position: center;
}

/* Label text */
#shopify-section-{{ section.id }} .brand-tab-label {
  font-size: 14px;
  font-weight: 600;
  color: #1f2937;
  line-height: 1;
  letter-spacing: -0.01em;
}

#shopify-section-{{ section.id }} .brand-tab-pill.active .brand-tab-label {
  color: #3b82f6;
}

/* loading indicator when fetching products */
#shopify-section-{{ section.id }} .carousel-track[style*="opacity: 0.5"] {
  position: relative;
}

#shopify-section-{{ section.id }} .carousel-track[style*="opacity: 0.5"]::after {
  content: 'Loading products...';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 16px;
  color: #6b7280;
  font-weight: 600;
  z-index: 100;
  background: #ffffff;
  padding: 20px 40px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* ============================================
   carousel container & track setup
   ============================================ */

#shopify-section-{{ section.id }} .carousel-wrapper {
  position: relative;
}

#shopify-section-{{ section.id }} .carousel-container {
  position: relative;
  padding: 0;
  margin: 0 60px;
}

/* wraps the track to add gradient fade */
#shopify-section-{{ section.id }} .carousel-track-container {
  position: relative;
  overflow: hidden;
  width: 100%;
}

#shopify-section-{{ section.id }} .carousel-track {
  display: flex;
  gap: 24px;
  overflow-x: auto;
  scroll-behavior: smooth;
  scroll-snap-type: x mandatory;
  scrollbar-width: none;
  -ms-overflow-style: none;
  padding: 24px 0;
}

#shopify-section-{{ section.id }} .carousel-track::-webkit-scrollbar {
  display: none;
}

/* ============================================
   gradient fade on right edge
   hints at more content to scroll
   ============================================ */

#shopify-section-{{ section.id }} .carousel-fade-overlay {
    position: absolute;
    top: 0;
    right: 0;
    width: 120px;
    height: 100%;
    background: linear-gradient(
      to right,
    rgba(242, 242, 242, 0) 0%,
    rgba(242, 242, 242, 0.69) 80%,
    rgba(242, 242, 242, 1) 100%
    );
    pointer-events: none;
    z-index: 5;
    transition: opacity 0.3s ease;
  }

/* hide the fade when scrolled all the way */
#shopify-section-{{ section.id }} .carousel-track-container.at-end .carousel-fade-overlay {
  opacity: 0;
}

/* ============================================
   prev/next arrows
   white buttons with black icons
   ============================================ */

#shopify-section-{{ section.id }} .carousel-arrow {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  color: #000000;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  z-index: 10;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

#shopify-section-{{ section.id }} .carousel-arrow:hover:not(:disabled) {
  background: #f9fafb;
  border-color: #d1d5db;
  transform: translateY(-50%) scale(1.05);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

#shopify-section-{{ section.id }} .carousel-arrow:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

#shopify-section-{{ section.id }} .carousel-arrow--prev {
  left: 0;
}

#shopify-section-{{ section.id }} .carousel-arrow--next {
  right: 0;
}

/* ============================================
   product cards - styled to match recently viewed products
   192px fixed width, compact design
   ============================================ */

#shopify-section-{{ section.id }} .spotlight-product-card {
  width: 192px;
  min-width: 192px;
  max-width: 192px;
  background: #ffffff;
  border-radius: 14px;
  padding: 20px;
  transition: transform 0.3s ease;
  scroll-snap-align: start;
  display: block;
  box-sizing: border-box;
  box-shadow: -1px 4px 16px rgba(0, 0, 0, 0.04);
}

#shopify-section-{{ section.id }} .spotlight-product-card:hover {
  transform: translateY(-4px);
}

#shopify-section-{{ section.id }} .spotlight-product-card * {
  max-width: 100%;
  box-sizing: border-box;
}

#shopify-section-{{ section.id }} .spotlight-card-link {
  text-decoration: none;
  color: inherit;
  display: block;
}

/* product image wrapper - 130x130px centered */
#shopify-section-{{ section.id }} .spotlight-card-image-wrapper {
  width: 130px;
  height: 130px;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 12px auto;
}

#shopify-section-{{ section.id }} .spotlight-card-image {
  width: 130px;
  height: 130px;
  object-fit: contain;
}

#shopify-section-{{ section.id }} .spotlight-card-image-placeholder {
  width: 130px;
  height: 130px;
  background: #f3f4f6;
}

/* color variant swatches - 12px circles, centered */
#shopify-section-{{ section.id }} .spotlight-card-swatches {
  display: flex;
  justify-content: center;
  gap: 6px;
  flex-wrap: wrap;
  min-height: 18px;
  padding-top: 4px;
  padding-bottom: 4px;
  margin-bottom: 8px;
}

#shopify-section-{{ section.id }} .spotlight-swatch {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 1px solid #E5E7EB;
  flex-shrink: 0;
}

#shopify-section-{{ section.id }} .spotlight-swatch-active {
  border-color: #99A1AF;
}

#shopify-section-{{ section.id }} .spotlight-swatch-more {
  font-size: 10px;
  font-weight: 700;
  color: #858585;
  line-height: 12px;
  flex-shrink: 0;
}

/* title wrapper - 40px fixed height */
#shopify-section-{{ section.id }} .spotlight-card-title-wrapper {
  height: 40px;
  margin-bottom: 8px;
}

#shopify-section-{{ section.id }} .spotlight-card-title {
  font-size: 13px;
  font-weight: 700;
  color: #0A0A0A;
  margin: 0;
  line-height: 20px;
  width: 130px;
  max-width: 130px;
  min-width: 0;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  word-break: break-word;
  overflow-wrap: break-word;
}

/* variant description wrapper - 19px fixed height */
#shopify-section-{{ section.id }} .spotlight-card-variant-wrapper {
  height: 19px;
  margin-bottom: 8px;
}

#shopify-section-{{ section.id }} .spotlight-card-variant {
  font-size: 11px;
  color: #4A5565;
  margin: 0;
  line-height: 19px;
  width: 130px;
  max-width: 130px;
  min-width: 0;
  display: -webkit-box;
  -webkit-line-clamp: 1;
  -webkit-box-orient: vertical;
  overflow: hidden;
  word-break: break-word;
  overflow-wrap: break-word;
}

/* pricing section */
#shopify-section-{{ section.id }} .spotlight-card-price {
  display: flex;
  align-items: baseline;
  gap: 8px;
  flex-wrap: wrap;
  max-width: 130px;
}

#shopify-section-{{ section.id }} .spotlight-price-current {
  font-size: 14px;
  font-weight: 700;
  color: #585858;
  line-height: 16px;
  white-space: nowrap;
}

#shopify-section-{{ section.id }} .spotlight-price-compare {
  font-size: 13px;
  color: #6A7282;
  text-decoration: line-through;
  line-height: 8px;
  white-space: nowrap;
}

#shopify-section-{{ section.id }} .spotlight-price-new-label {
  font-size: 13px;
  color: #6A7282;
  line-height: 24px;
  white-space: nowrap;
}

/* ============================================
   pagination dots below carousel
   ============================================ */

#shopify-section-{{ section.id }} .carousel-dots {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-top: 24px;
}

#shopify-section-{{ section.id }} .carousel-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #d1d5db;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  padding: 0;
}

#shopify-section-{{ section.id }} .carousel-dot:hover {
  background: #9ca3af;
}

#shopify-section-{{ section.id }} .carousel-dot.active {
  width: 8px;
  height: 8px;
  background: #007aff;
  transform: scale(1.2);
}

/* ============================================
   empty state when no products
   ============================================ */

#shopify-section-{{ section.id }} .carousel-empty,
#shopify-section-{{ section.id }} .spotlight-placeholder {
  padding: 60px 20px;
  text-align: center;
  color: #6b7280;
  font-size: 16px;
  grid-column: 1 / -1;
}

/* ============================================
   responsive breakpoints
   ============================================ */

/* tablets and smaller desktops */
@media (max-width: 1199px) {
  #shopify-section-{{ section.id }} .spotlight-layout {
    grid-template-columns: 35% 65%;
  }

  #shopify-section-{{ section.id }} .carousel-column {
    padding: 30px 40px;
  }

  #shopify-section-{{ section.id }} .brand-navigation-bar {
    gap: 12px;
    padding: 16px 20px;
  }

  #shopify-section-{{ section.id }} .carousel-track {
    gap: 16px;
  }

  #shopify-section-{{ section.id }} .carousel-fade-overlay {
    width: 100px;
  }
}

/* ============================================
   DESKTOP - Brand Tab Pills
   Clean pill layout, centered with horizontal scroll
   ============================================ */
@media (min-width: 768px) {
  #shopify-section-{{ section.id }} .brand-navigation-bar {
    justify-content: center;
    padding: 20px 32px;
    gap: 16px;
  }

  #shopify-section-{{ section.id }} .brand-tab-pill {
    min-height: 48px;
    padding: 12px 24px;
  }

  #shopify-section-{{ section.id }} .brand-tab-icon {
    flex: 0 0 24px;
    width: 24px;
    height: 24px;
  }

  #shopify-section-{{ section.id }} .brand-tab-icon svg {
    width: 24px;
    height: 24px;
  }

  #shopify-section-{{ section.id }} .brand-tab-logo {
    width: 24px;
    height: 24px;
  }

  #shopify-section-{{ section.id }} .brand-tab-label {
    font-size: 14px;
  }
}

/* phones and small tablets */
@media (max-width: 767px) {
  #shopify-section-{{ section.id }} .product-spotlight-section {
    padding: 15px 0;
  }

  #shopify-section-{{ section.id }} .spotlight-container {
    border-radius: 0;
    box-shadow: none;
    background-color: transparent; /* mobile-specific: prevent white blocks */
  }

  #shopify-section-{{ section.id }} .spotlight-layout {
    grid-template-columns: 1fr;
    min-height: auto;
  }

  /* Mobile Column Layout Control */
  /* Mobile: Single column layout (carousel only) - default */
  #shopify-section-{{ section.id }} .product-spotlight-section[data-mobile-layout="single-column"] .spotlight-layout {
    grid-template-columns: 100%;
  }

  #shopify-section-{{ section.id }} .product-spotlight-section[data-mobile-layout="single-column"] .hero-column {
    display: none;
  }

  /* Mobile: Two column layout (stacked vertically) */
  #shopify-section-{{ section.id }} .product-spotlight-section[data-mobile-layout="two-column"] .spotlight-layout {
    grid-template-columns: 1fr;
    grid-template-rows: auto 1fr;
  }

  #shopify-section-{{ section.id }} .product-spotlight-section[data-mobile-layout="two-column"] .hero-column {
    display: block;
    min-height: 250px;
  }

  /* Hide hero if mobile_show_hero is false */
  #shopify-section-{{ section.id }} .product-spotlight-section[data-mobile-show-hero="false"] .hero-column {
    display: none;
  }

  /* Legacy mobile hero visibility control (fallback) */
  #shopify-section-{{ section.id }} .hero-column {
    display: {% if section.settings.mobile_show_hero %}block{% else %}none{% endif %};
  }

  #shopify-section-{{ section.id }} .carousel-column {
    padding: 0;
    background-color: transparent !important; /* prevent white block on mobile */
  }

  /* ============================================
     MOBILE - Brand Tab Pills
     Compact horizontal pills with swipe scroll
     ============================================ */
  #shopify-section-{{ section.id }} .brand-navigation-bar {
    gap: 8px;
    padding: 12px 16px;
    justify-content: flex-start;
  }

  #shopify-section-{{ section.id }} .brand-tab-pill {
    min-height: 38px;
    padding: 8px 16px;
    gap: 6px;
  }

  #shopify-section-{{ section.id }} .brand-tab-pill.active {
    background: #3b82f6;
    border-color: #3b82f6;
  }

  #shopify-section-{{ section.id }} .brand-tab-pill.active .brand-tab-icon svg {
    color: #ffffff;
  }

  #shopify-section-{{ section.id }} .brand-tab-pill.active .brand-tab-label {
    color: #ffffff;
  }

  #shopify-section-{{ section.id }} .brand-tab-icon {
    flex: 0 0 18px;
    width: 18px;
    height: 18px;
  }

  #shopify-section-{{ section.id }} .brand-tab-icon svg {
    width: 18px;
    height: 18px;
  }

  #shopify-section-{{ section.id }} .brand-tab-logo {
    width: 18px;
    height: 18px;
  }

  #shopify-section-{{ section.id }} .brand-tab-label {
    font-size: 13px;
    font-weight: 500;
  }

  /* Full-width carousel container */
  #shopify-section-{{ section.id }} .carousel-container {
    margin: 0;
    padding: 0 16px;
  }

  /* Mobile: Product cards - maintain same styling as desktop */
  #shopify-section-{{ section.id }} .carousel-track {
    gap: 12px;
    padding: 24px 0;
  }

  #shopify-section-{{ section.id }} .carousel-fade-overlay {
    display: none;
  }

  /* Hide arrows on mobile - use swipe instead */
  #shopify-section-{{ section.id }} .carousel-arrow {
    display: none;
  }

  /* Mobile: Keep same card styling but allow flexible width */
  #shopify-section-{{ section.id }} .spotlight-product-card {
    width: 180px;
    min-width: 180px;
    max-width: 180px;
    padding: 20px;
    border-radius: 14px;
    box-shadow: -1px 4px 16px rgba(0, 0, 0, 0.15);
  }

  #shopify-section-{{ section.id }} .spotlight-product-card:hover {
    transform: translateY(-4px);
  }

  /* Enhanced page dots for mobile */
  #shopify-section-{{ section.id }} .carousel-dots {
    margin-top: 20px;
    padding: 0 0 20px;
  }

  #shopify-section-{{ section.id }} .carousel-dot {
    width: 6px;
    height: 6px;
  }

  #shopify-section-{{ section.id }} .carousel-dot.active {
    width: 20px;
    border-radius: 3px;
    background: #007aff;
  }
}
</style>

{%- # Load SKU Parser JavaScript for filtering -%}
<script src="{{ 'sku-parser.js' | asset_url }}" defer></script>

<script>
/**
 * carousel JS - handles filtering, arrows, touch etc
 * based on Back Market design
 *
 * Includes SKU-based product filtering for Brand New/Renewed toggle
 */
(function() {
  'use strict';

  const sectionId = '{{ section.id }}';
  const section = document.querySelector(`#shopify-section-${sectionId}`);
  if (!section) return;

  const carousel = section.querySelector('.carousel-container');
  const track = section.querySelector('.carousel-track');
  const trackContainer = section.querySelector('.carousel-track-container');
  const prevBtn = section.querySelector('.carousel-arrow--prev');
  const nextBtn = section.querySelector('.carousel-arrow--next');
  const dotsContainer = section.querySelector('.carousel-dots');
  const brandTabButtons = section.querySelectorAll('.brand-tab-pill');

  let currentPage = 0;
  let itemsPerPage = 3;
  let originalProductsHTML = ''; // save the original products for restore
  const showStartingAtText = {{ show_starting_at_text | json }}; // setting from schema
  const showNewPrice = {{ show_new_price_comparison | json }}; // setting from schema

  /**
   * setup everything on load
   */
  function init() {
    if (!track) return;

    // save initial products so we can restore them later
    originalProductsHTML = track.innerHTML;

    // Set CSS custom properties from data attributes
    const sectionElement = document.querySelector(`#shopify-section-${sectionId} .product-spotlight-section`);
    if (sectionElement) {
      // Section height
      const sectionHeight = sectionElement.getAttribute('data-section-height');
      if (sectionHeight) {
        sectionElement.style.setProperty('--section-height', `${sectionHeight}px`);
      }

      // Mobile card customization (only applies on mobile devices)
      const mobileCardWidth = sectionElement.getAttribute('data-mobile-card-width');
      const mobileCardHeight = sectionElement.getAttribute('data-mobile-card-height');
      const mobileImageHeight = sectionElement.getAttribute('data-mobile-image-height');
      const mobileCardPadding = sectionElement.getAttribute('data-mobile-card-padding');
      const mobileNavHeight = sectionElement.getAttribute('data-mobile-nav-height');
      const mobileNavPadding = sectionElement.getAttribute('data-mobile-nav-padding');
      const mobileNavSpacing = sectionElement.getAttribute('data-mobile-nav-spacing');
      const mobileIconSize = sectionElement.getAttribute('data-mobile-icon-size');

      if (mobileCardWidth) {
        sectionElement.style.setProperty('--mobile-card-width', `${mobileCardWidth}vw`);
      }
      if (mobileCardHeight) {
        sectionElement.style.setProperty('--mobile-card-height', `${mobileCardHeight}px`);
      }
      if (mobileImageHeight) {
        sectionElement.style.setProperty('--mobile-image-height', `${mobileImageHeight}px`);
      }
      if (mobileCardPadding) {
        sectionElement.style.setProperty('--mobile-card-padding', `${mobileCardPadding}px`);
      }
      if (mobileNavHeight) {
        sectionElement.style.setProperty('--mobile-nav-height', `${mobileNavHeight}px`);
      }
      if (mobileNavPadding) {
        sectionElement.style.setProperty('--mobile-nav-padding', `${mobileNavPadding}px`);
      }
      if (mobileNavSpacing) {
        sectionElement.style.setProperty('--mobile-nav-spacing', `${mobileNavSpacing}px`);
      }
      if (mobileIconSize) {
        sectionElement.style.setProperty('--mobile-icon-size', `${mobileIconSize}px`);
      }

      // Also set mobile-card-spacing from existing mobile_card_spacing setting
      const mobileCardSpacing = sectionElement.getAttribute('data-mobile-card-spacing') || '{{ section.settings.mobile_card_spacing | default: 16 }}';
      if (mobileCardSpacing) {
        sectionElement.style.setProperty('--mobile-card-spacing', `${mobileCardSpacing}px`);
      }

    }

    calculateItemsPerPage();
    updateNavigationState();
    createDots();
    updateFadeOverlay();
    attachEventListeners();

    // recalculate on window resize with debounce
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        calculateItemsPerPage();
        updateNavigationState();
        createDots();
      }, 250);
    });
  }

  /**
   * figure out how many cards fit on screen
   */
  function calculateItemsPerPage() {
    const width = window.innerWidth;
    if (width < 768) {
      itemsPerPage = 1;
    } else if (width < 1200) {
      itemsPerPage = 2;
    } else {
      itemsPerPage = 3;
    }
  }

  /**
   * get total number of pages
   */
  function getTotalPages() {
    const cards = track.querySelectorAll('.spotlight-product-card');
    return Math.ceil(cards.length / itemsPerPage);
  }

  /**
   * scroll to a specific page
   */
  function goToPage(pageIndex) {
    const totalPages = getTotalPages();
    if (pageIndex < 0) pageIndex = 0;
    if (pageIndex >= totalPages) pageIndex = totalPages - 1;

    currentPage = pageIndex;

    const cards = track.querySelectorAll('.spotlight-product-card');
    if (cards.length === 0) return;

    const cardWidth = cards[0].offsetWidth;
    const gap = window.innerWidth < 768 ? 16 : 20;
    const scrollAmount = (cardWidth + gap) * (pageIndex * itemsPerPage);

    track.scrollTo({
      left: scrollAmount,
      behavior: 'smooth'
    });

    updateNavigationState();
    updateDots();
    updateFadeOverlay();
  }

  /**
   * enable/disable arrow buttons based on current page
   */
  function updateNavigationState() {
    const totalPages = getTotalPages();

    if (prevBtn) {
      prevBtn.disabled = currentPage === 0;
    }

    if (nextBtn) {
      nextBtn.disabled = currentPage >= totalPages - 1;
    }
  }

  /**
   * build pagination dots dynamically
   */
  function createDots() {
    if (!dotsContainer) return;

    const totalPages = getTotalPages();
    dotsContainer.innerHTML = '';

    if (totalPages <= 1) {
      dotsContainer.style.display = 'none';
      return;
    }

    dotsContainer.style.display = 'flex';

    for (let i = 0; i < totalPages; i++) {
      const dot = document.createElement('button');
      dot.classList.add('carousel-dot');
      dot.setAttribute('aria-label', `Go to page ${i + 1}`);
      
      if (i === currentPage) {
        dot.classList.add('active');
      }

      dot.addEventListener('click', () => {
        goToPage(i);
      });
      
      dotsContainer.appendChild(dot);
    }
  }

  /**
   * update which dot is active
   */
  function updateDots() {
    if (!dotsContainer) return;

    const dots = dotsContainer.querySelectorAll('.carousel-dot');
    dots.forEach((dot, index) => {
      if (index === currentPage) {
        dot.classList.add('active');
      } else {
        dot.classList.remove('active');
      }
    });
  }

  /**
   * control gradient fade visibility
   * hides it when user scrolls to the end
   */
  function updateFadeOverlay() {
    if (!trackContainer || !track) return;
    
    const scrollLeft = track.scrollLeft;
    const scrollWidth = track.scrollWidth;
    const clientWidth = track.clientWidth;
    
    // check if we're at the end (with a bit of tolerance)
    const atEnd = scrollLeft + clientWidth >= scrollWidth - 10;
    
    if (atEnd) {
      trackContainer.classList.add('at-end');
    } else {
      trackContainer.classList.remove('at-end');
    }
  }

  /**
   * when user clicks a brand tab
   */
  function handleBrandClick(event) {
    const button = event.currentTarget;
    const collectionHandle = button.dataset.collection;
    const filter = button.dataset.filter;
    
    // switch active state to clicked tab
    brandTabButtons.forEach(tab => {
      tab.classList.remove('active');
      tab.setAttribute('aria-selected', 'false');
    });
    button.classList.add('active');
    button.setAttribute('aria-selected', 'true');

    // load products or restore original
    if (filter === 'all' || !collectionHandle || collectionHandle === '{{ featured_collection }}') {
      // just restore the original products - no reload
      restoreOriginalProducts();
    } else {
      // fetch from the collection API
      loadCollectionProducts(collectionHandle);
    }
  }

  /**
   * put back the original products (for "All" tab)
   */
  function restoreOriginalProducts() {
    if (!track || !originalProductsHTML) return;

    // fade out smoothly
    track.style.opacity = '0.5';
    track.style.pointerEvents = 'none';
    
    setTimeout(() => {
      track.innerHTML = originalProductsHTML;
      track.scrollLeft = 0;
      currentPage = 0;
      updateNavigationState();
      createDots();
      updateFadeOverlay();
      track.style.opacity = '1';
      track.style.pointerEvents = 'auto';
    }, 150);
  }

  /**
   * fetch products from a specific collection via API
   * Includes SKU-based filtering based on current mode
   */
  async function loadCollectionProducts(collectionHandle) {
    if (!track) return;

    try {
      // loading state
      track.style.opacity = '0.5';
      track.style.pointerEvents = 'none';

      // Get current mode from URL (use LooptechSKU if available, else simple check)
      const urlParams = new URLSearchParams(window.location.search);
      const currentMode = window.LooptechSKU?.getCurrentMode() || urlParams.get('mode') || 'brand-new';

      // hit the shopify API (fetch more than limit to account for filtering)
      const fetchLimit = Math.max({{ products_limit }} * 3, 100);
      const response = await fetch(`/collections/${collectionHandle}/products.json?limit=${fetchLimit}`);

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();

      // Filter products by SKU condition using LooptechSKU parser
      let filteredProducts = data.products || [];
      if (window.LooptechSKU) {
        filteredProducts = window.LooptechSKU.filterByMode(data.products || [], currentMode);
      }

      // Limit to products_limit after filtering
      filteredProducts = filteredProducts.slice(0, {{ products_limit }});

      // can remove this in prod if needed
      console.log('Loaded collection:', collectionHandle, 'Total:', data.products?.length, 'Filtered:', filteredProducts.length, 'Mode:', currentMode);

      // clear everything first
      track.innerHTML = '';

      if (filteredProducts.length > 0) {
        // build cards for each product
        filteredProducts.forEach((product, index) => {
          try {
            const card = createProductCard(product);
            track.appendChild(card);
          } catch (cardError) {
            console.error(`Error creating card for product ${product.id}:`, cardError, product);
          }
        });
      } else {
        // no products found after filtering
        track.innerHTML = `<div class="carousel-empty"><p>No ${currentMode} products found in this collection.</p></div>`;
      }

      // reset to first page
      track.scrollLeft = 0;
      currentPage = 0;
      updateNavigationState();
      createDots();
      updateFadeOverlay();

      // bring it back
      track.style.opacity = '1';
      track.style.pointerEvents = 'auto';

    } catch (error) {
      console.error('Error loading collection:', collectionHandle, error);
      track.innerHTML = `<div class="carousel-empty"><p>Failed to load products from "${collectionHandle}". Please check the collection handle.</p></div>`;
      track.style.opacity = '1';
      track.style.pointerEvents = 'auto';
    }
  }

  /**
   * build product card HTML dynamically
   * matches the liquid snippet structure exactly (recently viewed style)
   */
  function createProductCard(product) {
    const article = document.createElement('article');
    article.className = 'spotlight-product-card';
    article.dataset.productId = product.id;

    // grab first variant for pricing info
    const firstVariant = product.variants && product.variants[0] ? product.variants[0] : null;
    const productPrice = firstVariant ? firstVariant.price : product.price;
    const compareAtPrice = firstVariant ? firstVariant.compare_at_price : product.compare_at_price;

    // get product image - API returns it differently sometimes
    let imageHtml = '';
    let imageUrl = '';

    // check featured_image first
    if (product.featured_image) {
      imageUrl = product.featured_image;
    }
    // fall back to images array (these are objects with .src property)
    else if (product.images && product.images.length > 0) {
      // important: need to access .src property not the whole object
      imageUrl = product.images[0].src || product.images[0];
    }

    // build image HTML if we got a valid URL
    if (imageUrl && typeof imageUrl === 'string') {
      imageHtml = `<img src="${imageUrl}" alt="${escapeHtml(product.title)}" loading="lazy" class="spotlight-card-image">`;
    } else {
      imageHtml = '<div class="spotlight-card-image-placeholder"></div>';
    }

    // format prices - handles both cents and decimal formats
    const currentPrice = formatMoney(productPrice);
    const comparePriceFormatted = compareAtPrice ? formatMoney(compareAtPrice) : null;

    // build compare price HTML if applicable
    let comparePriceHtml = '';
    if (compareAtPrice && compareAtPrice > productPrice) {
      comparePriceHtml = `
        <span class="spotlight-price-compare">${comparePriceFormatted}</span>
        <span class="spotlight-price-new-label">new</span>
      `;
    }

    // build color swatches HTML from product options
    let swatchesHtml = '';
    if (product.options) {
      const colorOption = product.options.find(opt =>
        opt.name.toLowerCase() === 'color' || opt.name.toLowerCase() === 'colour'
      );
      if (colorOption && colorOption.values && colorOption.values.length > 0) {
        const maxSwatches = 4;
        const swatches = colorOption.values.slice(0, maxSwatches);
        swatches.forEach((color, index) => {
          const colorLower = color.toLowerCase();
          let swatchColor = '#CCCCCC';
          if (colorLower.includes('black')) swatchColor = '#000000';
          else if (colorLower.includes('white')) swatchColor = '#FFFFFF';
          else if (colorLower.includes('silver') || colorLower.includes('grey') || colorLower.includes('gray')) swatchColor = '#C0C0C0';
          else if (colorLower.includes('purple')) swatchColor = '#9D98FF';
          else if (colorLower.includes('red')) swatchColor = '#FF0C14';
          else if (colorLower.includes('blue')) swatchColor = '#0000FF';
          else if (colorLower.includes('green')) swatchColor = '#00FF00';
          else if (colorLower.includes('yellow') || colorLower.includes('gold')) swatchColor = '#FFD700';
          else if (colorLower.includes('pink') || colorLower.includes('rose')) swatchColor = '#FFC0CB';

          const activeClass = index === 0 ? 'spotlight-swatch-active' : '';
          swatchesHtml += `<div class="spotlight-swatch ${activeClass}" style="background-color: ${swatchColor}" title="${escapeHtml(color)}"></div>`;
        });

        if (colorOption.values.length > maxSwatches) {
          const additional = colorOption.values.length - maxSwatches;
          swatchesHtml += `<span class="spotlight-swatch-more">+${additional}</span>`;
        }
      }
    }

    // get variant title for display
    let variantHtml = '';
    if (firstVariant && firstVariant.title && firstVariant.title !== 'Default Title') {
      variantHtml = `<p class="spotlight-card-variant">${escapeHtml(firstVariant.title)}</p>`;
    }

    // build the card HTML - matches new simplified structure
    article.innerHTML = `
      <a href="/products/${product.handle}" class="spotlight-card-link" aria-label="View ${escapeHtml(product.title)}">
        <div class="spotlight-card-image-wrapper">
          ${imageHtml}
        </div>

        <div class="spotlight-card-swatches">
          ${swatchesHtml}
        </div>

        <div class="spotlight-card-title-wrapper">
          <h3 class="spotlight-card-title">${escapeHtml(product.title)}</h3>
        </div>

        <div class="spotlight-card-variant-wrapper">
          ${variantHtml}
        </div>

        <div class="spotlight-card-price">
          <span class="spotlight-price-current">${currentPrice}</span>
          ${comparePriceHtml}
        </div>
      </a>
    `;

    return article;
  }

  /**
   * format price for display
   * shopify API returns prices in different formats - need to handle both
   */
  function formatMoney(price) {
    // handle empty or null prices
    if (price === null || price === undefined || price === '') {
      return '0.00';
    }
    
    // convert to string to check the format
    const priceStr = String(price);
    let amount;
    
    // check if it's already a decimal (has a dot in it)
    if (priceStr.includes('.')) {
      // already in decimal like "99.99"
      amount = parseFloat(priceStr);
    } else {
      // in cents like 9999, divide by 100
      amount = parseFloat(priceStr) / 100;
    }
    
    // catch NaN errors
    if (isNaN(amount)) {
      console.warn('Invalid price value:', price);
      return '0.00';
    }
    
    return '' + amount.toFixed(2);
  }

  /**
   * escape HTML to prevent XSS attacks
   */
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  /**
   * setup all event listeners
   */
  function attachEventListeners() {
    if (prevBtn) {
      prevBtn.addEventListener('click', () => goToPage(currentPage - 1));
    }

    if (nextBtn) {
      nextBtn.addEventListener('click', () => goToPage(currentPage + 1));
    }

    brandTabButtons.forEach(tab => {
      tab.addEventListener('click', handleBrandClick);
    });

    // touch/swipe support for mobile
    let touchStartX = 0;
    let touchEndX = 0;
    let touchStartTime = 0;
    let touchEndTime = 0;
    let scrollEndTimer;

    track.addEventListener('touchstart', (e) => {
      touchStartX = e.changedTouches[0].screenX;
      touchStartTime = new Date().getTime();
    }, { passive: true });

    track.addEventListener('touchend', (e) => {
      touchEndX = e.changedTouches[0].screenX;
      touchEndTime = new Date().getTime();
      
      const diff = touchStartX - touchEndX;
      const timeDiff = touchEndTime - touchStartTime;
      const velocity = Math.abs(diff) / timeDiff;
      
      // Lower threshold for mobile and consider velocity
      const threshold = window.innerWidth < 768 ? 30 : 50;
      const velocityThreshold = 0.3;

      if (Math.abs(diff) > threshold || velocity > velocityThreshold) {
        if (diff > 0) {
          goToPage(currentPage + 1);
        } else {
          goToPage(currentPage - 1);
        }
      }
    }, { passive: true });

    // update fade overlay when scrolling + snap behavior for mobile
    track.addEventListener('scroll', () => {
      updateFadeOverlay();
      
      // Smooth snap behavior on mobile
      if (window.innerWidth < 768 && track) {
        const cards = track.querySelectorAll('.spotlight-product-card');
        if (cards.length > 0) {
          const cardWidth = cards[0].offsetWidth;
          const scrollPosition = track.scrollLeft;
          const pageIndex = Math.round(scrollPosition / cardWidth);
          
          // Update current page based on scroll position
          if (pageIndex !== currentPage) {
            currentPage = pageIndex;
            updateDots();
            updateNavigationState();
          }
        }
      }
    }, { passive: true });
  }

  // kick everything off
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();
</script>

{% schema %}
{
  "name": "Product Spotlight",
  "class": "section-product-spotlight",
  "settings": [
    {
      "type": "header",
      "content": "Spacing Settings"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "label": "Padding Top",
      "default": 24,
      "info": "Spacing above the section"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "label": "Padding Bottom",
      "default": 24,
      "info": "Spacing below the section"
    },
    {
      "type": "header",
      "content": "Layout Settings"
    },
    {
      "type": "range",
      "id": "left_column_width",
      "min": 20,
      "max": 50,
      "step": 5,
      "unit": "%",
      "label": "Left Column Width",
      "default": 30,
      "info": "Percentage width of hero image column (20-50%)"
    },
    {
      "type": "select",
      "id": "hero_position",
      "label": "Hero Image Position",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "left",
      "info": "Choose which side to display the hero image"
    },
    {
      "type": "header",
      "content": "Content Settings"
    },
    {
      "type": "text",
      "id": "section_heading",
      "label": "Section Heading",
      "default": "Top brands, Renewed",
      "info": "Main heading displayed above the carousel"
    },
    {
      "type": "image_picker",
      "id": "hero_image",
      "label": "Hero Image",
      "info": "Lifestyle/background image for the section (recommended: 600x800px)"
    },
    {
      "type": "header",
      "content": "Product Collection"
    },
    {
      "type": "collection",
      "id": "featured_collection",
      "label": "Product Collection",
      "info": "Main collection to display"
    },
    {
      "type": "collection",
      "id": "featured_collection_Renewed",
      "label": "Renewed Collection",
      "info": "Collection to show when in Renewed mode"
    },
    {
      "type": "header",
      "content": "Section Dimensions"
    },
    {
      "type": "range",
      "id": "section_height",
      "min": 400,
      "max": 900,
      "step": 50,
      "unit": "px",
      "label": "Carousel Height",
      "default": 600,
      "info": "Overall height of the carousel section"
    },
    {
      "type": "header",
      "content": "Desktop Layout Settings"
    },
    {
      "type": "select",
      "id": "desktop_column_layout",
      "label": "Desktop Column Layout",
      "options": [
        {
          "value": "two-column",
          "label": "2 Columns (Hero + Carousel)"
        },
        {
          "value": "single-column",
          "label": "1 Column (Carousel Only)"
        }
      ],
      "default": "two-column",
      "info": "Choose layout for desktop view"
    },
    {
      "type": "checkbox",
      "id": "desktop_show_hero",
      "label": "Show hero image on desktop",
      "default": true,
      "info": "Only applies when 2-column layout is selected"
    },
    {
      "type": "range",
      "id": "desktop_products_per_view",
      "min": 2,
      "max": 5,
      "step": 1,
      "label": "Products per view (desktop)",
      "default": 3,
      "info": "Number of product cards visible at once on desktop"
    },
    {
      "type": "header",
      "content": "Mobile Layout Settings"
    },
    {
      "type": "select",
      "id": "mobile_column_layout",
      "label": "Mobile Column Layout",
      "options": [
        {
          "value": "two-column",
          "label": "2 Columns (Hero + Carousel)"
        },
        {
          "value": "single-column",
          "label": "1 Column (Carousel Only)"
        }
      ],
      "default": "single-column",
      "info": "Choose layout for mobile view"
    },
    {
      "type": "checkbox",
      "id": "mobile_show_hero",
      "label": "Show hero image on mobile",
      "default": false,
      "info": "Only applies when 2-column layout is selected"
    },
    {
      "type": "header",
      "content": "Mobile Card Customization (Mobile Only)"
    },
    {
      "type": "paragraph",
      "content": "These settings control the product card appearance on mobile devices only. Adjust sizing to create a centered card with visible 'peek' to the next product for better swipe indication."
    },
    {
      "type": "range",
      "id": "mobile_card_width_percent",
      "min": 10,
      "max": 100,
      "step": 1,
      "unit": "%",
      "label": "Mobile Card Width",
      "default": 70,
      "info": "Percentage of screen width - full flexibility from tiny (10%) to full width (100%). 60-70% recommended for peek effect"
    },
    {
      "type": "range",
      "id": "mobile_card_height",
      "min": 200,
      "max": 900,
      "step": 10,
      "unit": "px",
      "label": "Mobile Card Height",
      "default": 420,
      "info": "Overall height of each product card on mobile - from compact (200px) to extra tall (900px)"
    },
    {
      "type": "range",
      "id": "mobile_product_image_height",
      "min": 100,
      "max": 600,
      "step": 10,
      "unit": "px",
      "label": "Mobile Product Image Height",
      "default": 250,
      "info": "Height of the product image within the card - from small (100px) to large (600px)"
    },
    {
      "type": "range",
      "id": "mobile_card_spacing",
      "min": 8,
      "max": 32,
      "step": 4,
      "unit": "px",
      "label": "Mobile Card Spacing",
      "default": 16,
      "info": "Gap between cards on mobile (affects peek visibility)"
    },
    {
      "type": "range",
      "id": "mobile_card_padding",
      "min": 8,
      "max": 24,
      "step": 2,
      "unit": "px",
      "label": "Mobile Card Inner Padding",
      "default": 12,
      "info": "Internal padding inside each card"
    },
    {
      "type": "header",
      "content": "Mobile Navigation Tabs (Mobile Only)"
    },
    {
      "type": "paragraph",
      "content": "Control the size and spacing of the brand navigation tabs on mobile devices."
    },
    {
      "type": "range",
      "id": "mobile_nav_tab_height",
      "min": 28,
      "max": 48,
      "step": 2,
      "unit": "px",
      "label": "Mobile Tab Height",
      "default": 36,
      "info": "Height of navigation tab buttons on mobile"
    },
    {
      "type": "range",
      "id": "mobile_nav_tab_padding",
      "min": 8,
      "max": 24,
      "step": 2,
      "unit": "px",
      "label": "Mobile Tab Horizontal Padding",
      "default": 16,
      "info": "Left and right padding inside tab buttons"
    },
    {
      "type": "range",
      "id": "mobile_nav_tab_spacing",
      "min": 4,
      "max": 16,
      "step": 2,
      "unit": "px",
      "label": "Mobile Tab Spacing",
      "default": 8,
      "info": "Gap between navigation tabs"
    },
    {
      "type": "range",
      "id": "mobile_nav_icon_size",
      "min": 14,
      "max": 24,
      "step": 2,
      "unit": "px",
      "label": "Mobile Tab Icon Size",
      "default": 18,
      "info": "Size of icons within navigation tabs"
    },
    {
      "type": "range",
      "id": "products_limit",
      "min": 4,
      "max": 24,
      "step": 1,
      "label": "Number of Products",
      "default": 12,
      "info": "Maximum number of products to display"
    },
    {
      "type": "header",
      "content": "Display Settings"
    },
    {
      "type": "checkbox",
      "id": "show_ratings",
      "label": "Show Star Ratings",
      "default": true,
      "info": "Display star ratings if available in product metafields"
    },
    {
      "type": "checkbox",
      "id": "show_starting_at_text",
      "label": "Show 'Starting at' Text",
      "default": true,
      "info": "Display 'Starting at' label above product prices"
    },
    {
      "type": "checkbox",
      "id": "show_new_price_comparison",
      "label": "Show 'New' price comparison",
      "default": false,
      "info": "Display crossed-out 'New' price on Renewed products to show savings vs. new price"
    },
    {
      "type": "header",
      "content": "Style Settings"
    },
    {
      "type": "color",
      "id": "carousel_background_color",
      "label": "Carousel Background Color",
      "default": "#ffffff",
      "info": "Background color behind product cards"
    }
  ],
  "blocks": [
    {
      "type": "brand_tab",
      "name": "Brand Tab",
      "limit": 10,
      "settings": [
        {
          "type": "image_picker",
          "id": "brand_logo",
          "label": "Brand Logo",
          "info": "Upload brand logo image (100x100px recommended)"
        },
        {
          "type": "text",
          "id": "brand_name",
          "label": "Brand Name",
          "default": "Brand",
          "info": "Brand name displayed below logo"
        },
        {
          "type": "collection",
          "id": "collection",
          "label": "Linked Collection",
          "info": "Collection to show when this brand is selected (optional)"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Spotlight Carousel",
      "category": "Products",
      "blocks": [
        {
          "type": "brand_tab",
          "settings": {
            "brand_name": "Apple"
          }
        },
        {
          "type": "brand_tab",
          "settings": {
            "brand_name": "Samsung"
          }
        },
        {
          "type": "brand_tab",
          "settings": {
            "brand_name": "Microsoft"
          }
        }
      ]
    }
  ]
}
{% endschema %}
