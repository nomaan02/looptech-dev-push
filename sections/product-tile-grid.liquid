{% comment %}
  Product Tile Grid Section
  Displays products in a grid layout with color variants and pricing
{% endcomment %}

<style>
  /* Section Container */
  .product-tile-grid-section {
    background: transparent;
    padding: {{ section.settings.padding_top }}px 0 {{ section.settings.padding_bottom }}px;
  }

  .product-tile-grid-container {
    max-width: 1270px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  @media (min-width: 1024px) {
    .product-tile-grid-container {
      padding: 0 2rem;
    }
  }

  /* Section Header */
  .product-tile-grid-header {
    text-align: {{ section.settings.heading_alignment }};
    margin-bottom: 2rem;
  }

  .product-tile-grid-title {
    font-size: {{ section.settings.heading_size }}px;
    font-weight: 600;
    color: {{ section.settings.heading_color }};
    margin: 0;
  }

  /* Grid Layout */
  .product-tile-grid {
    display: grid;
    grid-template-columns: repeat(1, 1fr);
    gap: 1.5rem;
  }

  @media (min-width: 640px) {
    .product-tile-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 768px) {
    .product-tile-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .product-tile-grid {
      grid-template-columns: repeat({{ section.settings.products_per_row }}, 1fr);
      gap: 2rem;
    }
  }

  /* Product Card */
  .product-tile-card {
    background: #ffffff;
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .product-tile-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12), 0 2px 4px rgba(0, 0, 0, 0.06);
  }

  /* Product Image */
  .product-tile-image-wrapper {
    position: relative;
    aspect-ratio: 1 / 1;
    overflow: hidden;
    border-radius: 8px;
    background-color: #f8f9fa;
    margin-bottom: 1rem;
  }

  .product-tile-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: 0.5rem;
  }

  .product-tile-badge {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    background: #ef4444;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    z-index: 1;
  }

  /* Product Info */
  .product-tile-info {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .product-tile-title {
    font-size: 1rem;
    font-weight: 500;
    color: #111827;
    margin: 0 0 0.5rem 0;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    text-decoration: none;
  }

  .product-tile-title:hover {
    color: {{ section.settings.link_hover_color }};
  }

  /* Pricing */
  .product-tile-pricing {
    margin-bottom: 0.75rem;
  }

  .product-tile-price-wrapper {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .product-tile-price {
    font-size: 1.25rem;
    font-weight: 600;
    color: #111827;
  }

  .product-tile-compare-price {
    font-size: 1rem;
    color: #6b7280;
    text-decoration: line-through;
  }

  .product-tile-save-badge {
    background: #10b981;
    color: white;
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  /* Color Variants */
  .product-tile-colors {
    margin-top: auto;
    padding-top: 0.75rem;
  }

  .product-tile-colors-label {
    font-size: 0.75rem;
    color: #6b7280;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .product-tile-color-swatches {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .product-tile-color-swatch {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 2px solid transparent;
    cursor: pointer;
    position: relative;
    transition: all 0.2s ease;
    box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.1);
  }

  .product-tile-color-swatch:hover {
    transform: scale(1.1);
    border-color: #3b82f6;
  }

  .product-tile-color-swatch.active {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), inset 0 0 0 1px rgba(0, 0, 0, 0.1);
  }

  /* Color swatch backgrounds */
  .product-tile-color-swatch[data-color="black"] {
    background-color: #000000;
  }

  .product-tile-color-swatch[data-color="white"] {
    background-color: #ffffff;
  }

  .product-tile-color-swatch[data-color="silver"] {
    background-color: #c0c0c0;
  }

  .product-tile-color-swatch[data-color="gold"] {
    background-color: #ffd700;
  }

  .product-tile-color-swatch[data-color="rose gold"] {
    background-color: #e8b4b8;
  }

  .product-tile-color-swatch[data-color="blue"] {
    background-color: #3b82f6;
  }

  .product-tile-color-swatch[data-color="purple"] {
    background-color: #9333ea;
  }

  .product-tile-color-swatch[data-color="red"] {
    background-color: #ef4444;
  }

  .product-tile-color-swatch[data-color="green"] {
    background-color: #10b981;
  }

  .product-tile-color-swatch[data-color="deep purple"] {
    background-color: #4c1d95;
  }

  /* Quick Add Button */
  .product-tile-quick-add {
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid #e5e7eb;
  }

  .product-tile-add-button {
    width: 100%;
    padding: 0.625rem 1rem;
    background: {{ section.settings.button_color }};
    color: {{ section.settings.button_text_color }};
    border: none;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .product-tile-add-button:hover {
    background: {{ section.settings.button_hover_color }};
    transform: translateY(-1px);
  }

  /* Loading State */
  .product-tile-loading {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 400px;
  }

  .product-tile-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #e5e7eb;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

<section class="product-tile-grid-section">
  <div class="product-tile-grid-container">
    {% if section.settings.heading != blank %}
      <div class="product-tile-grid-header">
        <h2 class="product-tile-grid-title">{{ section.settings.heading }}</h2>
      </div>
    {% endif %}

    <div class="product-tile-grid" id="product-tile-grid-{{ section.id }}">
      {% if section.settings.collection != blank %}
        {% assign collection = collections[section.settings.collection] %}
        {% assign products = collection.products | slice: 0, section.settings.products_to_show %}

        {% for product in products %}
          <div class="product-tile-card">
            <!-- Product Image -->
            <div class="product-tile-image-wrapper">
              {% if product.compare_at_price > product.price and section.settings.show_sale_badge %}
                {% assign discount = product.compare_at_price | minus: product.price | times: 100 | divided_by: product.compare_at_price %}
                <span class="product-tile-badge">-{{ discount }}%</span>
              {% endif %}

              <a href="{{ product.url }}">
                {% if product.featured_image %}
                  <img
                    src="{{ product.featured_image | image_url: width: 400 }}"
                    alt="{{ product.title | escape }}"
                    class="product-tile-image"
                    loading="lazy"
                  >
                {% else %}
                  {{ 'product-1' | placeholder_svg_tag: 'product-tile-image' }}
                {% endif %}
              </a>
            </div>

            <!-- Product Info -->
            <div class="product-tile-info">
              <a href="{{ product.url }}" class="product-tile-title">
                {{ product.title }}
              </a>

              <!-- Pricing -->
              <div class="product-tile-pricing">
                <div class="product-tile-price-wrapper">
                  <span class="product-tile-price">
                    {{ product.price | money }}
                  </span>

                  {% if product.compare_at_price > product.price and section.settings.show_compare_price %}
                    <span class="product-tile-compare-price">
                      {{ product.compare_at_price | money }}
                    </span>

                    {% if section.settings.show_save_amount %}
                      {% assign saved = product.compare_at_price | minus: product.price %}
                      <span class="product-tile-save-badge">
                        Save {{ saved | money }}
                      </span>
                    {% endif %}
                  {% endif %}
                </div>
              </div>

              <!-- Color Variants -->
              {% if section.settings.show_color_swatches %}
                {% assign color_option = product.options_by_name['Color'] %}
                {% if color_option != nil %}
                  <div class="product-tile-colors">
                    <div class="product-tile-colors-label">Colors Available</div>
                    <div class="product-tile-color-swatches">
                      {% for color_value in color_option.values limit: 6 %}
                        <button
                          class="product-tile-color-swatch {% if forloop.first %}active{% endif %}"
                          data-color="{{ color_value | downcase }}"
                          data-product-id="{{ product.id }}"
                          data-variant-color="{{ color_value }}"
                          title="{{ color_value }}"
                          aria-label="Color: {{ color_value }}"
                        ></button>
                      {% endfor %}

                      {% if color_option.values.size > 6 %}
                        <span style="font-size: 0.75rem; color: #6b7280; align-self: center;">
                          +{{ color_option.values.size | minus: 6 }}
                        </span>
                      {% endif %}
                    </div>
                  </div>
                {% endif %}
              {% endif %}

              <!-- Quick Add Button -->
              {% if section.settings.show_quick_add %}
                <div class="product-tile-quick-add">
                  <button
                    class="product-tile-add-button"
                    data-product-id="{{ product.id }}"
                    data-variant-id="{{ product.first_available_variant.id }}"
                  >
                    {% if product.available %}
                      {{ section.settings.add_to_cart_text }}
                    {% else %}
                      {{ section.settings.sold_out_text }}
                    {% endif %}
                  </button>
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <!-- Placeholder when no collection selected -->
        <div class="product-tile-grid" style="grid-template-columns: repeat(4, 1fr);">
          {% for i in (1..4) %}
            <div class="product-tile-card">
              <div class="product-tile-image-wrapper">
                {{ 'product-' | append: i | placeholder_svg_tag: 'product-tile-image' }}
              </div>
              <div class="product-tile-info">
                <div class="product-tile-title">Sample Product {{ i }}</div>
                <div class="product-tile-pricing">
                  <div class="product-tile-price-wrapper">
                    <span class="product-tile-price">$99.99</span>
                    <span class="product-tile-compare-price">$129.99</span>
                  </div>
                </div>
                <div class="product-tile-colors">
                  <div class="product-tile-colors-label">Colors Available</div>
                  <div class="product-tile-color-swatches">
                    <button class="product-tile-color-swatch active" data-color="black"></button>
                    <button class="product-tile-color-swatch" data-color="silver"></button>
                    <button class="product-tile-color-swatch" data-color="gold"></button>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const section = document.getElementById('product-tile-grid-{{ section.id }}');
    if (!section) return;

    // Handle color swatch selection
    const colorSwatches = section.querySelectorAll('.product-tile-color-swatch');
    colorSwatches.forEach(swatch => {
      swatch.addEventListener('click', function(e) {
        e.preventDefault();

        // Remove active class from siblings
        const siblings = this.parentElement.querySelectorAll('.product-tile-color-swatch');
        siblings.forEach(s => s.classList.remove('active'));

        // Add active class to clicked swatch
        this.classList.add('active');

        // You can add logic here to update product image based on color selection
        const productId = this.dataset.productId;
        const variantColor = this.dataset.variantColor;

        // Optional: Update product image or variant
        console.log(`Selected color: ${variantColor} for product: ${productId}`);
      });
    });

    // Handle quick add button
    const addButtons = section.querySelectorAll('.product-tile-add-button');
    addButtons.forEach(button => {
      button.addEventListener('click', async function(e) {
        e.preventDefault();

        const variantId = this.dataset.variantId;
        const originalText = this.textContent;

        // Show loading state
        this.textContent = 'Adding...';
        this.disabled = true;

        try {
          // Add to cart via Shopify AJAX API
          const formData = new FormData();
          formData.append('id', variantId);
          formData.append('quantity', '1');

          const response = await fetch('/cart/add.js', {
            method: 'POST',
            body: formData
          });

          if (response.ok) {
            const data = await response.json();
            this.textContent = 'Added!';

            // Update cart count if needed
            document.dispatchEvent(new CustomEvent('cart:update', { detail: data }));

            // Reset button after delay
            setTimeout(() => {
              this.textContent = originalText;
              this.disabled = false;
            }, 2000);
          } else {
            throw new Error('Failed to add to cart');
          }
        } catch (error) {
          console.error('Error adding to cart:', error);
          this.textContent = 'Error';
          setTimeout(() => {
            this.textContent = originalText;
            this.disabled = false;
          }, 2000);
        }
      });
    });
  });
</script>

{% schema %}
{
  "name": "Product Tile Grid",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "default": "Featured Products"
    },
    {
      "type": "select",
      "id": "heading_alignment",
      "label": "Heading Alignment",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "center"
    },
    {
      "type": "range",
      "id": "heading_size",
      "label": "Heading Size",
      "min": 20,
      "max": 48,
      "step": 2,
      "default": 32,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#111827"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection",
      "info": "Select a collection to display products from"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "label": "Number of Products",
      "min": 4,
      "max": 24,
      "step": 4,
      "default": 8
    },
    {
      "type": "range",
      "id": "products_per_row",
      "label": "Products per Row (Desktop)",
      "min": 3,
      "max": 5,
      "step": 1,
      "default": 4
    },
    {
      "type": "header",
      "content": "Product Card Settings"
    },
    {
      "type": "checkbox",
      "id": "show_compare_price",
      "label": "Show Compare Price",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_save_amount",
      "label": "Show Save Amount",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_sale_badge",
      "label": "Show Sale Badge",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_color_swatches",
      "label": "Show Color Swatches",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_quick_add",
      "label": "Show Quick Add Button",
      "default": true
    },
    {
      "type": "text",
      "id": "add_to_cart_text",
      "label": "Add to Cart Text",
      "default": "Add to Cart"
    },
    {
      "type": "text",
      "id": "sold_out_text",
      "label": "Sold Out Text",
      "default": "Sold Out"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button Color",
      "default": "#3b82f6"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button Text Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "button_hover_color",
      "label": "Button Hover Color",
      "default": "#2563eb"
    },
    {
      "type": "color",
      "id": "link_hover_color",
      "label": "Link Hover Color",
      "default": "#3b82f6"
    },
    {
      "type": "header",
      "content": "Section Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Top Padding",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 48,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Bottom Padding",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 48,
      "unit": "px"
    }
  ],
  "presets": [
    {
      "name": "Product Tile Grid",
      "settings": {
        "heading": "Featured Products",
        "products_to_show": 8,
        "products_per_row": 4
      }
    }
  ]
}
{% endschema %}