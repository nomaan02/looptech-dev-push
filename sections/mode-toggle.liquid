{%- comment -%}
  Mode Toggle Section
  Switches between Brand New and Renewed product views

  This toggle works with the SKU-based product filtering system.
  Products are filtered based on their SKU condition code:
    - NEW → Brand New mode
    - ren, ren, ren → Renewed mode

  Compatible with both collection-based and SKU-based filtering.
{%- endcomment -%}

{%- comment -%}
  INLINE MODE DETECTION
  DO NOT use render 'detect-current-mode' - Liquid's render tag creates isolated
  variable scope, so current_mode would be undefined in this parent template.
{%- endcomment -%}
{%- liquid
  assign current_mode = 'brand-new'
  assign has_url_mode = false
  assign url_string = request.url | downcase

  if url_string contains 'mode=renewed'
    assign current_mode = 'renewed'
    assign has_url_mode = true
  elsif url_string contains 'mode=brand-new'
    assign current_mode = 'brand-new'
    assign has_url_mode = true
  elsif url_string contains 'mode=new'
    assign current_mode = 'brand-new'
    assign has_url_mode = true
  endif
-%}

<div class="mode-toggle-section color-{{ section.settings.color_scheme }} gradient" style="padding-top: {{ section.settings.padding_top }}px; padding-bottom: {{ section.settings.padding_bottom }}px;">
  <div class="page-width">
    <div class="mode-toggle-wrapper">
      {%- if section.settings.heading != blank -%}
        <div class="mode-toggle-heading">
          <h2 class="mode-toggle-title">{{ section.settings.heading }}</h2>
        </div>
      {%- endif -%}

      <div class="mode-toggle-container">
        <div class="mode-toggle-track" data-current-mode="{{ current_mode }}">
          <div class="mode-toggle-slider" data-position="{{ current_mode }}"></div>
          <button
            class="mode-toggle-option {% if current_mode == 'brand-new' %}active{% endif %}"
            data-mode="brand-new"
            aria-pressed="{% if current_mode == 'brand-new' %}true{% else %}false{% endif %}"
            type="button">
            <span class="mode-toggle-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
              </svg>
            </span>
            <span class="mode-toggle-label">{{ section.settings.new_label | default: "Brand New" }}</span>
          </button>
          <button
            class="mode-toggle-option {% if current_mode == 'renewed' %}active{% endif %}"
            data-mode="renewed"
            aria-pressed="{% if current_mode == 'renewed' %}true{% else %}false{% endif %}"
            type="button">
            <span class="mode-toggle-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21.5 2V8M21.5 8H15.5M21.5 8L18 4.5C16.5 3 14.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C16.5 22 20.5 19 21.5 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            <span class="mode-toggle-label">{{ section.settings.refurb_label | default: "Renewed" }}</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Modern Toggle Switch Design */
  .mode-toggle-section {
    width: 100%;
  }

  /* Ensure consistent max-width */
  .mode-toggle-section .page-width {
    max-width: 1270px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  @media (min-width: 1024px) {
    .mode-toggle-section .page-width {
      padding: 0;
    }
  }

  /* Wrapper for inline layout */
  .mode-toggle-wrapper {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
  }

  .mode-toggle-heading {
    text-align: left;
    margin: 0;
    flex: 1;
  }

  .mode-toggle-title {
    margin: 0;
    font-size: 1.125rem;  /* Reduced to better match toggle height */
    font-weight: 600;
    color: rgb(var(--color-foreground));
    line-height: 1.2;
  }

  .mode-toggle-container {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    flex-shrink: 0;
  }

  /* Toggle Track - Rounded bevelled container */
  .mode-toggle-track {
    position: relative;
    display: inline-flex;
    background: linear-gradient(145deg, #e8eef5, #f5f8fc);
    border-radius: 50px;
    padding: 3px;  /* Reduced padding */
    box-shadow:
      inset 0 1px 3px rgba(0, 0, 0, 0.05),
      0 1px 4px rgba(59, 130, 246, 0.06);
    border: 1px solid rgba(59, 130, 246, 0.1);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    height: 36px;  /* Fixed height to match text */
  }

  .mode-toggle-track:hover {
    box-shadow:
      inset 0 1px 3px rgba(0, 0, 0, 0.06),
      0 2px 6px rgba(59, 130, 246, 0.1);
  }

  /* Sliding Indicator */
  .mode-toggle-slider {
    position: absolute;
    top: 3px;
    left: 3px;
    height: calc(100% - 6px);
    width: calc(50% - 3px);
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    border-radius: 50px;
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow:
      0 2px 4px rgba(59, 130, 246, 0.2),
      0 1px 2px rgba(0, 0, 0, 0.06),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    z-index: 1;
  }

  /* Move slider to renewed position */
  .mode-toggle-slider[data-position="renewed"] {
    transform: translateX(calc(100% + 3px));
  }

  /* Toggle Options */
  .mode-toggle-option {
    position: relative;
    z-index: 2;
    display: flex;
    align-items: center;
    gap: 4px;  /* Reduced gap */
    padding: 6px 16px;  /* Reduced padding */
    min-width: 120px;  /* Reduced width */
    font-size: 0.8125rem;  /* Slightly smaller text */
    font-weight: 600;
    background: transparent;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    color: #64748b;
    justify-content: center;
    height: 30px;  /* Fixed height for consistency */
  }

  .mode-toggle-option:hover {
    color: #475569;
    transform: scale(1.02);
  }

  /* Active state - white text when slider is behind */
  .mode-toggle-option.active {
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  /* Icon styling */
  .mode-toggle-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .mode-toggle-icon svg {
    width: 14px;  /* Reduced icon size */
    height: 14px;
  }

  .mode-toggle-option:hover .mode-toggle-icon {
    transform: scale(1.05) rotate(3deg);
  }

  .mode-toggle-option.active .mode-toggle-icon {
    transform: scale(1.1);
  }

  /* Label text */
  .mode-toggle-label {
    font-size: 0.8125rem;
    font-weight: 600;
    letter-spacing: 0.01em;
    transition: all 0.3s ease;
  }

  /* Focus state for accessibility */
  .mode-toggle-option:focus-visible {
    outline: 3px solid #3b82f6;
    outline-offset: 4px;
  }

  /* Add subtle animation on load */
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .mode-toggle-track {
    animation: slideIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Mobile Responsive Design */
  @media screen and (max-width: 749px) {
    .mode-toggle-wrapper {
      flex-direction: column;
      align-items: stretch;
      gap: 1rem;
    }

    .mode-toggle-heading {
      text-align: center;
    }

    .mode-toggle-container {
      justify-content: center;
    }

    .mode-toggle-title {
      font-size: 1.125rem;
    }

    .mode-toggle-track {
      height: 34px;
    }

    .mode-toggle-option {
      padding: 5px 14px;
      min-width: 110px;
      font-size: 0.75rem;
      height: 28px;
    }

    .mode-toggle-label {
      font-size: 0.75rem;
    }

    .mode-toggle-icon svg {
      width: 13px;
      height: 13px;
    }
  }

  @media screen and (max-width: 480px) {
    .mode-toggle-option {
      padding: 5px 12px;
      min-width: 100px;
      font-size: 0.75rem;
      gap: 3px;
    }

    .mode-toggle-label {
      font-size: 0.75rem;
    }

    .mode-toggle-icon svg {
      width: 12px;
      height: 12px;
    }

    .mode-toggle-title {
      font-size: 1rem;
    }
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .mode-toggle-track {
      border: 2px solid currentColor;
    }

    .mode-toggle-slider {
      background: #1d4ed8;
    }

    .mode-toggle-option.active {
      font-weight: 700;
    }
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .mode-toggle-slider,
    .mode-toggle-option,
    .mode-toggle-icon {
      transition-duration: 0.01ms;
    }

    .mode-toggle-track {
      animation: none;
    }
  }
</style>

<script>
  (function() {
    'use strict';

    const STORAGE_KEY = 'looptech_mode';
    const DEFAULT_MODE = 'brand-new';
    const VALID_MODES = ['brand-new', 'renewed'];

    const toggleOptions = document.querySelectorAll('.mode-toggle-option[data-mode]');
    const slider = document.querySelector('.mode-toggle-slider');
    const track = document.querySelector('.mode-toggle-track');

    // Normalize legacy mode values
    function normalizeMode(mode) {
      if (mode === 'new') return 'brand-new';
      if (mode === 'Renewed') return 'renewed';
      return mode;
    }

    // Get current mode from URL or localStorage
    function getCurrentMode() {
      const urlParams = new URLSearchParams(window.location.search);
      let mode = urlParams.get('mode');

      // Normalize legacy values
      mode = normalizeMode(mode);

      if (VALID_MODES.includes(mode)) {
        try {
          localStorage.setItem(STORAGE_KEY, mode);
        } catch(e) {}
        return mode;
      }

      // Fall back to localStorage
      try {
        mode = localStorage.getItem(STORAGE_KEY);
        if (VALID_MODES.includes(mode)) {
          return mode;
        }
      } catch(e) {}

      return DEFAULT_MODE;
    }

    // Initialize slider position on load
    function initializeSlider() {
      const currentMode = getCurrentMode();

      if (slider) {
        slider.setAttribute('data-position', currentMode);
      }

      // Update active states
      toggleOptions.forEach(option => {
        const optionMode = option.getAttribute('data-mode');
        if (optionMode === currentMode) {
          option.classList.add('active');
          option.setAttribute('aria-pressed', 'true');
        } else {
          option.classList.remove('active');
          option.setAttribute('aria-pressed', 'false');
        }
      });
    }

    // Set mode and navigate
    function setMode(newMode) {
      if (!VALID_MODES.includes(newMode)) {
        console.error('Invalid mode:', newMode);
        return;
      }

      try {
        localStorage.setItem(STORAGE_KEY, newMode);
      } catch(error) {
        console.warn('Could not save mode preference:', error);
      }

      const url = new URL(window.location.href);
      url.searchParams.set('mode', newMode);
      window.location.href = url.toString();
    }

    // Handle toggle click
    toggleOptions.forEach(option => {
      option.addEventListener('click', function(e) {
        e.preventDefault();

        const newMode = this.getAttribute('data-mode');

        // Check URL mode, not localStorage - URL is the source of truth for Liquid
        const urlParams = new URLSearchParams(window.location.search);
        const urlMode = urlParams.get('mode');

        // Only skip navigation if URL already has the correct mode parameter
        // This fixes the bug where localStorage had mode but URL didn't
        if (urlMode === newMode) {
          return;
        }

        // Update UI immediately before reload for smooth UX
        if (slider) {
          slider.setAttribute('data-position', newMode);
        }

        toggleOptions.forEach(btn => {
          const btnMode = btn.getAttribute('data-mode');
          if (btnMode === newMode) {
            btn.classList.add('active');
            btn.setAttribute('aria-pressed', 'true');
          } else {
            btn.classList.remove('active');
            btn.setAttribute('aria-pressed', 'false');
          }
        });

        // Small delay to show animation before reload
        setTimeout(() => {
          setMode(newMode);
        }, 150);
      });
    });

    // Sync localStorage preference to URL (ensures Liquid gets the correct mode)
    // This fixes the bug where DOMContentLoaded might not fire if script loads after DOM ready
    function syncURLWithLocalStorage() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const urlMode = urlParams.get('mode');

        // If URL has no mode, but localStorage does, redirect to add mode to URL
        if (!urlMode) {
          const storedMode = localStorage.getItem(STORAGE_KEY);
          if (storedMode && VALID_MODES.includes(storedMode)) {
            const url = new URL(window.location.href);
            url.searchParams.set('mode', storedMode);
            window.location.href = url.toString();
            return; // Stop execution, page will reload
          }
        }
      } catch(error) {
        console.warn('Could not sync mode preference:', error);
      }
    }

    // Initialize slider and sync URL - handles both DOM loaded and not loaded cases
    function init() {
      initializeSlider();
      syncURLWithLocalStorage();
    }

    // Expose globally for debugging and external use
    window.LooptechToggle = {
      getCurrentMode: getCurrentMode,
      setMode: setMode,
      STORAGE_KEY: STORAGE_KEY
    };

    // Run initialization - whether DOM is loading or already loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>

{% schema %}
{
  "name": "Mode Toggle",
  "class": "section",
  "settings": [
    {
      "type": "paragraph",
      "content": "This toggle switches between Brand New and Renewed product views across your entire store."
    },
    {
      "type": "paragraph",
      "content": "**How it works:** Products are filtered based on their SKU condition code (4th segment). Brand New shows products with 'NEW' condition. Renewed shows products with 'ren', 'ren', or 'ren' conditions."
    },
    {
      "type": "header",
      "content": "Content Settings"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "default": "Browse Between Brand New & Renewed Devices With Ease!",
      "info": "Leave blank to hide heading"
    },
    {
      "type": "text",
      "id": "new_label",
      "label": "Brand New Button Label",
      "default": "Brand New",
      "info": "Shows products with SKU condition code: NEW"
    },
    {
      "type": "text",
      "id": "refurb_label",
      "label": "Renewed Button Label",
      "default": "Renewed",
      "info": "Shows products with SKU condition codes: ren, ren, ren"
    },
    {
      "type": "header",
      "content": "Collection Mapping"
    },
    {
      "type": "paragraph",
      "content": "**Brand New Mode:** Displays products from your main collections (e.g., 'all-new', 'new-phones', 'new-laptops') and filters by SKU condition 'NEW'."
    },
    {
      "type": "paragraph",
      "content": "**Renewed Mode:** Displays products from your Renewed collections (e.g., 'all-Renewed', 'Renewed-phones', 'Renewed-laptops') and filters by SKU conditions 'ren', 'ren', 'ren'."
    },
    {
      "type": "paragraph",
      "content": "Configure collection settings in individual sections (Product Spotlight Carousel, Featured Collections, etc.)."
    },
    {
      "type": "header",
      "content": "Design Settings"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "background-1"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding top",
      "default": 20
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding bottom",
      "default": 20
    }
  ],
  "presets": [
    {
      "name": "Mode Toggle",
      "category": "Custom"
    }
  ]
}
{% endschema %}
