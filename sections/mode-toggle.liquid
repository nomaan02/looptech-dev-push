{%- comment -%}
  Mode Toggle Section
  Switches between Brand New and Refurbished product views

  This toggle works with the SKU-based product filtering system.
  Products are filtered based on their SKU condition code:
    - NEW → Brand New mode
    - REFA, REFB, REFC → Refurbished mode

  Compatible with both collection-based and SKU-based filtering.
{%- endcomment -%}

{%- liquid
  # Detect mode from URL parameter
  assign url_mode = request.url | split: 'mode=' | last | split: '&' | first
  assign current_mode = 'new'
  if url_mode == 'refurbished'
    assign current_mode = 'refurbished'
  endif

  # For SKU-based sections, determine which condition codes to match
  if current_mode == 'new'
    assign target_conditions = 'NEW'
  else
    assign target_conditions = 'REFA,REFB,REFC'
  endif
-%}

<div class="mode-toggle-section color-{{ section.settings.color_scheme }} gradient" style="padding-top: {{ section.settings.padding_top }}px; padding-bottom: {{ section.settings.padding_bottom }}px;">
  <div class="page-width">
    {%- if section.settings.heading != blank -%}
      <div class="mode-toggle-heading">
        <h2 class="mode-toggle-title">{{ section.settings.heading }}</h2>
      </div>
    {%- endif -%}

    <div class="mode-toggle-wrapper">
      <button
        class="mode-toggle-button {% if current_mode == 'new' %}active{% endif %}"
        data-mode="new"
        aria-pressed="{% if current_mode == 'new' %}true{% else %}false{% endif %}"
        type="button">
        {{ section.settings.new_label | default: "Brand New" }}
      </button>
      <button
        class="mode-toggle-button {% if current_mode == 'refurbished' %}active{% endif %}"
        data-mode="refurbished"
        aria-pressed="{% if current_mode == 'refurbished' %}true{% else %}false{% endif %}"
        type="button">
        {{ section.settings.refurb_label | default: "Refurbished" }}
      </button>
    </div>
  </div>
</div>

<style>
  .mode-toggle-section {
    width: 100%;
  }

  .mode-toggle-heading {
    text-align: center;
    margin-bottom: 2rem;
  }

  .mode-toggle-title {
    margin: 0;
    font-size: 2rem;
    font-weight: 600;
  }

  .mode-toggle-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .mode-toggle-button {
    padding: 1rem 2.5rem;
    font-size: 1rem;
    font-weight: 500;
    border: 2px solid rgba(0, 0, 0, 0.2);
    background: transparent;
    color: rgb(var(--color-foreground));
    cursor: pointer;
    transition: all 0.3s ease;
    border-radius: 4px;
    min-width: 150px;
    text-align: center;
  }

  .mode-toggle-button:hover {
    border-color: rgba(0, 0, 0, 0.4);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .mode-toggle-button.active {
    background: rgb(var(--color-foreground));
    color: rgb(var(--color-background));
    border-color: rgb(var(--color-foreground));
  }

  .mode-toggle-button:focus-visible {
    outline: 2px solid rgb(var(--color-foreground));
    outline-offset: 2px;
  }

  /* Mobile responsive */
  @media screen and (max-width: 749px) {
    .mode-toggle-title {
      font-size: 1.5rem;
    }

    .mode-toggle-wrapper {
      flex-direction: row;
      gap: 0.75rem;
    }

    .mode-toggle-button {
      padding: 0.875rem 1.5rem;
      font-size: 0.9375rem;
      min-width: 130px;
    }
  }

  @media screen and (max-width: 480px) {
    .mode-toggle-wrapper {
      flex-direction: column;
      width: 100%;
    }

    .mode-toggle-button {
      width: 100%;
      max-width: 300px;
    }
  }
</style>

<script>
  (function() {
    const buttons = document.querySelectorAll('.mode-toggle-button[data-mode]');

    buttons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();

        const newMode = this.getAttribute('data-mode');
        const url = new URL(window.location.href);

        // Update URL parameter
        url.searchParams.set('mode', newMode);

        // Store preference in localStorage
        try {
          localStorage.setItem('preferredMode', newMode);
        } catch(error) {
          console.warn('Could not save mode preference:', error);
        }

        // Update active state immediately for better UX
        buttons.forEach(btn => {
          btn.classList.remove('active');
          btn.setAttribute('aria-pressed', 'false');
        });
        this.classList.add('active');
        this.setAttribute('aria-pressed', 'true');

        // Reload page with new mode
        window.location.href = url.toString();
      });
    });

    // On page load, check if we should apply stored preference
    document.addEventListener('DOMContentLoaded', function() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const urlMode = urlParams.get('mode');

        // Only apply localStorage if no URL parameter exists
        if (!urlMode) {
          const storedMode = localStorage.getItem('preferredMode');
          if (storedMode && (storedMode === 'new' || storedMode === 'refurbished')) {
            const url = new URL(window.location.href);
            url.searchParams.set('mode', storedMode);
            window.location.href = url.toString();
          }
        }
      } catch(error) {
        console.warn('Could not apply stored mode preference:', error);
      }
    });
  })();
</script>

{% schema %}
{
  "name": "Mode Toggle",
  "class": "section",
  "settings": [
    {
      "type": "paragraph",
      "content": "This toggle switches between Brand New and Refurbished product views across your entire store."
    },
    {
      "type": "paragraph",
      "content": "**How it works:** Products are filtered based on their SKU condition code (4th segment). Brand New shows products with 'NEW' condition. Refurbished shows products with 'REFA', 'REFB', or 'REFC' conditions."
    },
    {
      "type": "header",
      "content": "Content Settings"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "default": "Shop Our Products",
      "info": "Leave blank to hide heading"
    },
    {
      "type": "text",
      "id": "new_label",
      "label": "Brand New Button Label",
      "default": "Brand New",
      "info": "Shows products with SKU condition code: NEW"
    },
    {
      "type": "text",
      "id": "refurb_label",
      "label": "Refurbished Button Label",
      "default": "Refurbished",
      "info": "Shows products with SKU condition codes: REFA, REFB, REFC"
    },
    {
      "type": "header",
      "content": "Collection Mapping"
    },
    {
      "type": "paragraph",
      "content": "**Brand New Mode:** Displays products from your main collections (e.g., 'all-new', 'new-phones', 'new-laptops') and filters by SKU condition 'NEW'."
    },
    {
      "type": "paragraph",
      "content": "**Refurbished Mode:** Displays products from your refurbished collections (e.g., 'all-refurbished', 'refurbished-phones', 'refurbished-laptops') and filters by SKU conditions 'REFA', 'REFB', 'REFC'."
    },
    {
      "type": "paragraph",
      "content": "Configure collection settings in individual sections (Product Spotlight Carousel, Featured Collections, etc.)."
    },
    {
      "type": "header",
      "content": "Design Settings"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "background-1"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding bottom",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Mode Toggle",
      "category": "Custom"
    }
  ]
}
{% endschema %}
