{%- comment -%}
  Mode Toggle Section - Dual Behavior

  ARCHITECTURE:
  - On COLLECTION pages with dual content: Uses in-place JavaScript swap
  - On COLLECTION pages without dual content: Uses <a> links → navigates to parallel collection
  - On NON-COLLECTION pages: Uses <button> → JavaScript swaps visibility in-place

  Required:
  - Collections must follow naming: {category} (brand-new) / {category}-renewed
  - Product sections must have [data-mode-content="brand-new"] and [data-mode-content="renewed"] wrappers
{%- endcomment -%}

{%- liquid
  # ═══════════════════════════════════════════════════════════════════════
  # PAGE TYPE DETECTION
  # ═══════════════════════════════════════════════════════════════════════

  assign is_collection_page = false
  assign current_mode = 'brand-new'
  assign current_handle = collection.handle | default: ''
  assign base_handle = ''

  if current_handle != blank
    assign is_collection_page = true

    # Detect mode from collection handle suffix
    # Convention: {base} = brand-new, {base}-renewed = renewed
    if current_handle contains '-renewed'
      assign current_mode = 'renewed'
      assign base_handle = current_handle | remove: '-renewed'
    else
      # Collection without -renewed suffix is brand-new
      assign current_mode = 'brand-new'
      assign base_handle = current_handle
    endif
  endif

  # ═══════════════════════════════════════════════════════════════════════
  # BUILD COLLECTION URLS (for collection pages only)
  # ═══════════════════════════════════════════════════════════════════════

  if is_collection_page
    # Build parallel collection handles
    # Convention: {base} = brand-new, {base}-renewed = renewed
    if base_handle != blank
      assign new_handle = base_handle
      assign renewed_handle = base_handle | append: '-renewed'
    else
      assign new_handle = 'all'
      assign renewed_handle = 'all-renewed'
    endif

    assign new_url = '/collections/' | append: new_handle
    assign renewed_url = '/collections/' | append: renewed_handle

    # Preserve query params (sort, filters) when switching
    assign current_query = ''
    assign full_url = request.url | default: ''

    if full_url contains '?'
      assign url_parts = full_url | split: '?'
      if url_parts.size > 1
        assign query_string = url_parts[1]
        assign params = query_string | split: '&'

        for param in params
          unless param contains 'mode=' or param == ''
            if current_query == ''
              assign current_query = '?' | append: param
            else
              assign current_query = current_query | append: '&' | append: param
            endif
          endunless
        endfor
      endif
    endif

    assign new_url = new_url | append: current_query
    assign renewed_url = renewed_url | append: current_query
  endif

  # Get labels from settings
  assign new_label = section.settings.new_label | default: 'Brand New'
  assign renewed_label = section.settings.refurb_label | default: 'Renewed'
-%}

<div class="mode-toggle-section color-{{ section.settings.color_scheme }} gradient"
     style="padding-top: {{ section.settings.padding_top }}px; padding-bottom: {{ section.settings.padding_bottom }}px;"
     data-is-collection-page="{{ is_collection_page }}">
  <div class="page-width">
    <div class="mode-toggle-wrapper">
      {%- if section.settings.heading != blank -%}
        <div class="mode-toggle-heading">
          <h2 class="mode-toggle-title">{{ section.settings.heading }}</h2>
        </div>
      {%- endif -%}

      <nav class="mode-toggle-container" aria-label="Product condition filter">
        <div class="mode-toggle-track" data-current-mode="{{ current_mode }}">
          <div class="mode-toggle-slider" data-position="{{ current_mode }}"></div>

          {%- if is_collection_page -%}
            {%- comment -%} COLLECTION PAGE: Navigation links {%- endcomment -%}
            <a
              href="{{ new_url }}"
              class="mode-toggle__option{% if current_mode == 'brand-new' %} mode-toggle__option--active{% endif %}"
              data-mode="brand-new"
              {% if current_mode == 'brand-new' %}aria-current="page"{% endif %}
            >
              <span class="mode-toggle__icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                </svg>
              </span>
              <span class="mode-toggle__text">{{ new_label }}</span>
            </a>

            <a
              href="{{ renewed_url }}"
              class="mode-toggle__option{% if current_mode == 'renewed' %} mode-toggle__option--active{% endif %}"
              data-mode="renewed"
              {% if current_mode == 'renewed' %}aria-current="page"{% endif %}
            >
              <span class="mode-toggle__icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M21.5 2V8M21.5 8H15.5M21.5 8L18 4.5C16.5 3 14.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C16.5 22 20.5 19 21.5 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <span class="mode-toggle__text">{{ renewed_label }}</span>
            </a>

          {%- else -%}
            {%- comment -%} NON-COLLECTION PAGE: JavaScript buttons for in-place swap {%- endcomment -%}
            <button
              type="button"
              class="mode-toggle__option mode-toggle__option--active"
              data-mode-switch="brand-new"
              data-mode="brand-new"
            >
              <span class="mode-toggle__icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                </svg>
              </span>
              <span class="mode-toggle__text">{{ new_label }}</span>
            </button>

            <button
              type="button"
              class="mode-toggle__option"
              data-mode-switch="renewed"
              data-mode="renewed"
            >
              <span class="mode-toggle__icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M21.5 2V8M21.5 8H15.5M21.5 8L18 4.5C16.5 3 14.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C16.5 22 20.5 19 21.5 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <span class="mode-toggle__text">{{ renewed_label }}</span>
            </button>
          {%- endif -%}
        </div>
      </nav>
    </div>
  </div>
</div>

<style>
  /* ═══════════════════════════════════════════════════════════════════════
     MODE TOGGLE - Dual Behavior Styles
     ═══════════════════════════════════════════════════════════════════════ */

  .mode-toggle-section {
    width: 100%;
  }

  .mode-toggle-section .page-width {
    max-width: 1270px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  @media (min-width: 1024px) {
    .mode-toggle-section .page-width {
      padding: 0;
    }
  }

  .mode-toggle-wrapper {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
  }

  .mode-toggle-heading {
    text-align: left;
    margin: 0;
    flex: 1;
  }

  .mode-toggle-title {
    margin: 0;
    font-size: 1.225rem;
    font-weight: 600;
    color: rgb(var(--color-foreground));
    line-height: 1.2;
  }

  .mode-toggle-container {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    flex-shrink: 0;
  }

  /* ─────────────────────────────────────────────────────────────────────
     Toggle Track
     ───────────────────────────────────────────────────────────────────── */

  .mode-toggle-track {
    position: relative;
    display: inline-flex;
    background: linear-gradient(145deg, #e8eef5, #f5f8fc);
    border-radius: 50px;
    padding: 3px;
    box-shadow:
      inset 0 1px 3px rgba(0, 0, 0, 0.05),
      0 1px 4px rgba(59, 130, 246, 0.06);
    border: 1px solid rgba(59, 130, 246, 0.1);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    height: 36px;
  }

  .mode-toggle-track:hover {
    box-shadow:
      inset 0 1px 3px rgba(0, 0, 0, 0.06),
      0 2px 6px rgba(59, 130, 246, 0.1);
  }

  /* ─────────────────────────────────────────────────────────────────────
     Sliding Indicator
     ───────────────────────────────────────────────────────────────────── */

  .mode-toggle-slider {
    position: absolute;
    top: 3px;
    left: 3px;
    height: calc(100% - 6px);
    width: calc(50% - 3px);
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    border-radius: 50px;
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow:
      0 2px 4px rgba(59, 130, 246, 0.2),
      0 1px 2px rgba(0, 0, 0, 0.06),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    z-index: 1;
    pointer-events: none;
  }

  .mode-toggle-slider[data-position="renewed"] {
    transform: translateX(calc(100% + 3px));
  }

  /* ─────────────────────────────────────────────────────────────────────
     Toggle Options (both <a> and <button>)
     ───────────────────────────────────────────────────────────────────── */

  .mode-toggle__option {
    position: relative;
    z-index: 2;
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 6px 16px;
    min-width: 120px;
    font-size: 0.8125rem;
    font-weight: 600;
    background: transparent;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    color: #64748b;
    justify-content: center;
    height: 30px;
    text-decoration: none;
    font-family: inherit;
  }

  .mode-toggle__option:hover {
    color: #475569;
    transform: scale(1.02);
    text-decoration: none;
  }

  .mode-toggle__option--active {
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .mode-toggle__option--active:hover {
    color: #ffffff;
  }

  /* ─────────────────────────────────────────────────────────────────────
     Icons
     ───────────────────────────────────────────────────────────────────── */

  .mode-toggle__icon {
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .mode-toggle__icon svg {
    width: 14px;
    height: 14px;
  }

  .mode-toggle__option:hover .mode-toggle__icon {
    transform: scale(1.05) rotate(3deg);
  }

  .mode-toggle__option--active .mode-toggle__icon {
    transform: scale(1.1);
  }

  /* ─────────────────────────────────────────────────────────────────────
     Text Label
     ───────────────────────────────────────────────────────────────────── */

  .mode-toggle__text {
    font-size: 0.9525rem;
    font-weight: 600;
    letter-spacing: 0.01em;
    transition: all 0.3s ease;
  }

  /* ─────────────────────────────────────────────────────────────────────
     Accessibility
     ───────────────────────────────────────────────────────────────────── */

  .mode-toggle__option:focus-visible {
    outline: 3px solid #3b82f6;
    outline-offset: 4px;
  }

  /* ─────────────────────────────────────────────────────────────────────
     Animation on load
     ───────────────────────────────────────────────────────────────────── */

  @keyframes modeToggleSlideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .mode-toggle-track {
    animation: modeToggleSlideIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* ─────────────────────────────────────────────────────────────────────
     Mobile Responsive
     ───────────────────────────────────────────────────────────────────── */

  @media screen and (max-width: 749px) {
    .mode-toggle-wrapper {
      flex-direction: column;
      align-items: stretch;
      gap: 1rem;
    }

    .mode-toggle-heading {
      text-align: center;
    }

    .mode-toggle-container {
      justify-content: center;
    }

    .mode-toggle-title {
      font-size: 1.125rem;
    }

    .mode-toggle-track {
      height: 34px;
    }

    .mode-toggle__option {
      padding: 5px 14px;
      min-width: 110px;
      font-size: 0.75rem;
      height: 28px;
    }

    .mode-toggle__text {
      font-size: 0.75rem;
    }

    .mode-toggle__icon svg {
      width: 13px;
      height: 13px;
    }
  }

  @media screen and (max-width: 480px) {
    .mode-toggle__option {
      padding: 5px 12px;
      min-width: 100px;
      font-size: 0.8125rem;
      gap: 3px;
    }

    .mode-toggle__text {
      font-size: 0.75rem;
    }

    .mode-toggle__icon svg {
      width: 12px;
      height: 12px;
    }

    .mode-toggle-title {
      font-size: 1rem;
    }
  }

  /* ─────────────────────────────────────────────────────────────────────
     Accessibility Preferences
     ───────────────────────────────────────────────────────────────────── */

  @media (prefers-contrast: high) {
    .mode-toggle-track {
      border: 2px solid currentColor;
    }

    .mode-toggle-slider {
      background: #1d4ed8;
    }

    .mode-toggle__option--active {
      font-weight: 700;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .mode-toggle-slider,
    .mode-toggle__option,
    .mode-toggle__icon {
      transition-duration: 0.01ms;
    }

    .mode-toggle-track {
      animation: none;
    }
  }
</style>

<script>
/**
 * Mode Toggle - Dual Behavior JavaScript
 *
 * SMART DETECTION:
 * - If page has [data-mode-content] elements → use in-place JavaScript swap
 * - Otherwise on collection pages → use navigation links (if they exist)
 *
 * This ensures the toggle works correctly whether:
 * - Using LoopTech Collection (dual collections pre-rendered)
 * - Using traditional parallel collections (navigation)
 */
(function() {
  'use strict';

  const STORAGE_KEY = 'looptech-mode';
  const VALID_MODES = ['brand-new', 'renewed'];

  // ═══════════════════════════════════════════════════════════════════════
  // SMART DETECTION - Check if in-place swap is available
  // ═══════════════════════════════════════════════════════════════════════

  function hasDualContent() {
    // Check if page has pre-rendered dual content (both brand-new and renewed)
    const brandNewContent = document.querySelector('[data-mode-content="brand-new"]');
    const renewedContent = document.querySelector('[data-mode-content="renewed"]');
    return brandNewContent !== null && renewedContent !== null;
  }

  // ═══════════════════════════════════════════════════════════════════════
  // UTILITY FUNCTIONS
  // ═══════════════════════════════════════════════════════════════════════

  function getStoredMode() {
    try {
      const mode = localStorage.getItem(STORAGE_KEY);
      return VALID_MODES.includes(mode) ? mode : 'brand-new';
    } catch (e) {
      return 'brand-new';
    }
  }

  function setStoredMode(mode) {
    try {
      localStorage.setItem(STORAGE_KEY, mode);
    } catch (e) {
      // localStorage not available
    }
  }

  // ═══════════════════════════════════════════════════════════════════════
  // IN-PLACE MODE SWAP
  // ═══════════════════════════════════════════════════════════════════════

  function applyMode(mode) {
    if (!VALID_MODES.includes(mode)) return;

    // Store preference
    setStoredMode(mode);

    // Update ALL toggle option states (both buttons and links)
    document.querySelectorAll('.mode-toggle__option').forEach(el => {
      const elMode = el.getAttribute('data-mode');
      if (elMode === mode) {
        el.classList.add('mode-toggle__option--active');
      } else {
        el.classList.remove('mode-toggle__option--active');
      }
    });

    // Update slider position
    const slider = document.querySelector('.mode-toggle-slider');
    if (slider) {
      slider.setAttribute('data-position', mode);
    }

    // Update track data attribute
    const track = document.querySelector('.mode-toggle-track');
    if (track) {
      track.setAttribute('data-current-mode', mode);
    }

    // Swap visibility of all mode-content sections
    document.querySelectorAll('[data-mode-content]').forEach(el => {
      const contentMode = el.getAttribute('data-mode-content');
      if (contentMode === mode) {
        el.style.display = '';
        el.removeAttribute('hidden');
      } else {
        el.style.display = 'none';
        el.setAttribute('hidden', '');
      }
    });

    // Dispatch custom event so other components (like carousels) can react
    window.dispatchEvent(new CustomEvent('looptech-mode-change', { detail: { mode: mode } }));

    console.log('[LoopTech Mode Toggle] Applied mode:', mode);
  }

  // ═══════════════════════════════════════════════════════════════════════
  // HOVER ANIMATION (All Pages)
  // ═══════════════════════════════════════════════════════════════════════

  function setupHoverAnimation() {
    const options = document.querySelectorAll('.mode-toggle__option');
    const slider = document.querySelector('.mode-toggle-slider');
    const track = document.querySelector('.mode-toggle-track');

    if (!slider || !track || options.length === 0) return;

    options.forEach(option => {
      option.addEventListener('mouseenter', function() {
        const hoverMode = this.getAttribute('data-mode');
        if (hoverMode) {
          slider.setAttribute('data-position', hoverMode);
        }
      });

      option.addEventListener('mouseleave', function() {
        // Return to current active mode
        const currentMode = track.getAttribute('data-current-mode') || 'brand-new';
        slider.setAttribute('data-position', currentMode);
      });
    });
  }

  // ═══════════════════════════════════════════════════════════════════════
  // CONVERT LINKS TO BUTTONS (when dual content is available)
  // ═══════════════════════════════════════════════════════════════════════

  function convertLinksToInPlaceSwap() {
    // Find all toggle links and convert them to in-place swap behavior
    document.querySelectorAll('.mode-toggle__option[href]').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault(); // Prevent navigation
        const newMode = this.getAttribute('data-mode');
        applyMode(newMode);
      });
    });

    // Also handle button-style toggles
    document.querySelectorAll('[data-mode-switch]').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        const newMode = this.getAttribute('data-mode-switch');
        applyMode(newMode);
      });
    });
  }

  // ═══════════════════════════════════════════════════════════════════════
  // INITIALIZATION
  // ═══════════════════════════════════════════════════════════════════════

  function init() {
    // Always setup hover animation
    setupHoverAnimation();

    // Check if page has dual content (pre-rendered brand-new and renewed)
    const useInPlaceSwap = hasDualContent();

    if (useInPlaceSwap) {
      // Page has dual content - use in-place swap
      console.log('[LoopTech Mode Toggle] Detected dual content - using in-place swap');
    
      // Apply stored mode after a tick to ensure all listeners are registered
      const storedMode = getStoredMode();
      requestAnimationFrame(function() {
        applyMode(storedMode);
      });

      // Convert any navigation links to in-place swap
      convertLinksToInPlaceSwap();

    } else {
      // No dual content - allow navigation (for traditional parallel collections)
      console.log('[LoopTech Mode Toggle] No dual content - using navigation mode');

      // Just track the current mode for localStorage
      const track = document.querySelector('.mode-toggle-track');
      if (track) {
        const currentMode = track.getAttribute('data-current-mode');
        if (currentMode && VALID_MODES.includes(currentMode)) {
          setStoredMode(currentMode);
        }
      }
    }
  }

  // Expose API for external use
  window.LooptechModeToggle = {
    getMode: getStoredMode,
    setMode: applyMode,
    STORAGE_KEY: STORAGE_KEY
  };

  // Run on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>

{% schema %}
{
  "name": "Mode Toggle",
  "class": "section",
  "settings": [
    {
      "type": "paragraph",
      "content": "**Collection naming:** {handle} = Brand New, {handle}-renewed = Renewed (e.g., 'iphones' and 'iphones-renewed')"
    },
    {
      "type": "paragraph",
      "content": "**On pages with dual content:** Toggle swaps visibility in-place. **Otherwise:** Navigates to parallel collection."
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "default": "Browse Between Brand New & Renewed Devices With Ease!",
      "info": "Leave blank to hide heading"
    },
    {
      "type": "text",
      "id": "new_label",
      "label": "Brand New Button Label",
      "default": "Brand New"
    },
    {
      "type": "text",
      "id": "refurb_label",
      "label": "Renewed Button Label",
      "default": "Renewed"
    },
    {
      "type": "header",
      "content": "Design"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "background-1"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding top",
      "default": 20
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding bottom",
      "default": 20
    }
  ],
  "presets": [
    {
      "name": "Mode Toggle",
      "category": "Custom"
    }
  ]
}
{% endschema %}
