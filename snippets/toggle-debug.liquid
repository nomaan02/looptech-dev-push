{%- comment -%}
  TOGGLE DEBUG SNIPPET

  Displays a debug panel showing current toggle state and product filtering.

  Usage: Add to theme.liquid before </body>:
    {%- render 'toggle-debug' -%}

  Remove after testing is complete.
{%- endcomment -%}

{%- comment -%}
  INLINE MODE DETECTION - DO NOT use render 'detect-current-mode'
  Liquid's render tag creates isolated variable scope.
{%- endcomment -%}
{%- liquid
  assign current_mode = 'brand-new'
  assign has_url_mode = false
  assign url_string = request.url | downcase

  if url_string contains 'mode=renewed'
    assign current_mode = 'renewed'
    assign has_url_mode = true
  elsif url_string contains 'mode=brand-new'
    assign current_mode = 'brand-new'
    assign has_url_mode = true
  elsif url_string contains 'mode=new'
    assign current_mode = 'brand-new'
    assign has_url_mode = true
  endif
-%}

<div id="looptech-debug" style="position: fixed; bottom: 20px; right: 20px; background: #1f2937; color: white; padding: 16px; border-radius: 8px; font-family: monospace; font-size: 12px; z-index: 9999; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
  <div style="font-weight: bold; margin-bottom: 8px; color: #60a5fa; display: flex; justify-content: space-between; align-items: center;">
    <span>Toggle Debug</span>
    <button onclick="document.getElementById('looptech-debug').style.display='none'" style="background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 16px;">&times;</button>
  </div>

  <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #374151;">
    <div><strong>Current Mode:</strong> <span style="color: {% if current_mode == 'brand-new' %}#10b981{% else %}#3b82f6{% endif %}">{{ current_mode }}</span></div>
    <div><strong>URL Mode:</strong> {{ request.url | split: 'mode=' | last | split: '&' | first | default: '(none)' }}</div>
  </div>

  {% if collection %}
    <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #374151;">
      <div><strong>Collection:</strong> {{ collection.title }}</div>
      <div><strong>Total Products:</strong> {{ collection.products.size }}</div>

      {%- assign debug_visible = 0 -%}
      {%- assign debug_brand_new = 0 -%}
      {%- assign debug_renewed = 0 -%}
      {%- assign debug_unknown = 0 -%}

      {%- for product in collection.products limit: 50 -%}
        {%- comment -%} INLINE PRODUCT MODE DETECTION {%- endcomment -%}
        {%- liquid
          assign show_product = false
          assign product_mode = 'unknown'

          # Check product tags first
          if product.tags contains 'brand-new'
            assign product_mode = 'brand-new'
          elsif product.tags contains 'renewed'
            assign product_mode = 'renewed'
          endif

          # Fallback: Parse SKU condition code
          if product_mode == 'unknown'
            assign sku = product.selected_or_first_available_variant.sku | default: ''
            assign sku_parts = sku | split: '-'
            if sku_parts.size >= 6
              assign sku_condition = sku_parts[3] | upcase
              if sku_condition == 'NEW'
                assign product_mode = 'brand-new'
              elsif sku_condition == 'REN' or sku_condition == 'REFA' or sku_condition == 'REFB' or sku_condition == 'REFC'
                assign product_mode = 'renewed'
              endif
            endif
          endif

          # Apply filter
          if product_mode == current_mode or product_mode == 'unknown'
            assign show_product = true
          endif
        -%}
        {%- if show_product -%}
          {%- assign debug_visible = debug_visible | plus: 1 -%}
        {%- endif -%}
        {%- if product_mode == 'brand-new' -%}
          {%- assign debug_brand_new = debug_brand_new | plus: 1 -%}
        {%- elsif product_mode == 'renewed' -%}
          {%- assign debug_renewed = debug_renewed | plus: 1 -%}
        {%- else -%}
          {%- assign debug_unknown = debug_unknown | plus: 1 -%}
        {%- endif -%}
      {%- endfor -%}

      <div style="margin-top: 8px;">
        <div><strong>Visible (first 50):</strong> {{ debug_visible }}</div>
        <div style="color: #10b981;">Brand New: {{ debug_brand_new }}</div>
        <div style="color: #3b82f6;">Renewed: {{ debug_renewed }}</div>
        <div style="color: #9ca3af;">Unknown: {{ debug_unknown }}</div>
      </div>
    </div>
  {% endif %}

  <div style="display: flex; gap: 8px; margin-top: 8px;">
    <button onclick="window.LooptechToggle?.setMode('brand-new')" style="flex: 1; padding: 8px; background: {% if current_mode == 'brand-new' %}#10b981{% else %}#374151{% endif %}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
      Brand New
    </button>
    <button onclick="window.LooptechToggle?.setMode('renewed')" style="flex: 1; padding: 8px; background: {% if current_mode == 'renewed' %}#3b82f6{% else %}#374151{% endif %}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
      Renewed
    </button>
  </div>

  <div style="margin-top: 8px; font-size: 10px; color: #6b7280;">
    <div>localStorage: <span id="debug-storage">-</span></div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    try {
      const storageValue = localStorage.getItem('looptech_mode') || '(not set)';
      const storageEl = document.getElementById('debug-storage');
      if (storageEl) storageEl.textContent = storageValue;
    } catch(e) {
      console.log('Debug: Could not read localStorage');
    }
  });
</script>
